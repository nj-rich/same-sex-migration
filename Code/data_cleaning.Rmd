---
title: "data_cleaning"
output: html_document

---
Load packages
```{r, include = F}
gc()
library(tidyverse) #for data work
library(data.table) #for data loading

#watch these packages for dummies
install.packages("fastDummies") # --- recipes package might also work or tidymodels? (step_dummy maybe work darn recipe use confusion) (or not- different method) - issue: combo 2 years - check
library(fastDummies)
```

Download the data
```{r, include = F}
gc()

pull1_csv <- fread("C:\\Users\\njrich\\Downloads\\pull1.csv")

#note might need to redownload to factor in ASECWT weights - watch individual v household serial and rules of weights
```

Select out unneeded variables
```{r, include = F}
gc()


```

Identify individuals in same-sex relationships  
```{r, include = F}
gc()
partner <- pull1_csv %>%
  select(YEAR, SERIAL, PERNUM, SEX) 

gc()
df_partners <- pull1_csv %>%
  left_join(partner, join_by(YEAR, SERIAL, SPLOC == PERNUM), suffix = c(".indv", ".partner"))

gc()
df_samesex <- df_partners %>% #WATCH CLARITY WHERE SPLOC IS
  mutate(in_samesex = case_when(
    (SEX.indv == 1) & (SEX.partner == 1) ~ 1, #gay
    (SEX.indv == 2) & (SEX.partner == 2) ~ 1, #gay
    (SEX.indv == 2) & (SEX.partner == 1) ~ 0, #straight
    (SEX.indv == 1) & (SEX.partner == 2) ~ 0, #straight
    (SEX.indv == 9) | (SEX.partner == 9) ~ NA #NA 
  ))

rm(partner, df_partners, pull1_csv)
#check all mutate works             
```

Label states/input legalization year/length of time since legalization (use FIP) 
```{r, include = F}

#label states
gc()
df_samesex <- df_samesex %>%
  mutate(state_name = NA) %>% #ok this seems to work
  mutate(state_name = case_when( 
    STATEFIP == 1 ~ "AL",
    STATEFIP == 2 ~ "AK",
    STATEFIP == 4 ~ "AZ",
    STATEFIP == 5 ~ "AR",
    STATEFIP == 6 ~ "CA",
    STATEFIP == 8 ~ "CO",
    STATEFIP == 9 ~ "CT",
    STATEFIP == 10 ~ "DE")) 

gc()
df_samesex <- df_samesex %>%
  mutate(state_name = case_when(
    STATEFIP == 11 ~ "DC",
    STATEFIP == 12 ~ "FL",
    STATEFIP == 13 ~ "GA",
    STATEFIP == 15 ~ "HI",
    STATEFIP == 16 ~ "ID",
    STATEFIP == 17 ~ "IL",
    STATEFIP == 18 ~ "IN",
    STATEFIP == 19 ~ "IA",
    STATEFIP == 20 ~ "KS")) 

gc()
df_samesex <- df_samesex %>%
  mutate(state_name = case_when(
    STATEFIP == 21 ~ "KY",
    STATEFIP == 22 ~ "LA",
    STATEFIP == 23 ~ "MI",
    STATEFIP == 24 ~ "MD",
    STATEFIP == 25 ~ "MA",
    STATEFIP == 26 ~ "ME",
    STATEFIP == 27 ~ "MN",
    STATEFIP == 28 ~ "MS",
    STATEFIP == 29 ~ "MO",
    STATEFIP == 30 ~ "MT")) 

gc()
df_samesex <- df_samesex %>%
  mutate(state_name = case_when(
    STATEFIP == 31 ~ "NE",
    STATEFIP == 32 ~ "NV",
    STATEFIP == 33 ~ "NH",
    STATEFIP == 34 ~ "NJ",
    STATEFIP == 35 ~ "NM",
    STATEFIP == 36 ~ "NY",
    STATEFIP == 37 ~ "NC",
    STATEFIP == 38 ~ "ND",
    STATEFIP == 39 ~ "OH",
    STATEFIP == 40 ~ "OK")) 

gc()
df_samesex <- df_samesex %>%
  mutate(state_name = case_when(
    STATEFIP == 41 ~ "OR",
    STATEFIP == 42 ~ "PA",
    STATEFIP == 44 ~ "RI",
    STATEFIP == 45 ~ "SC",
    STATEFIP == 46 ~ "SD",
    STATEFIP == 47 ~ "TN",
    STATEFIP == 48 ~ "TX",
    STATEFIP == 49 ~ "UT",
    STATEFIP == 50 ~ "VT",
    STATEFIP == 51 ~ "VA",
    STATEFIP == 53 ~ "WA",
    STATEFIP == 54 ~ "WV",
    STATEFIP == 55 ~ "WI",
    STATEFIP == 56 ~ "WY",
    STATEFIP == 72 ~ "PR",
    STATEFIP == 97 ~ "OMI", #Overseas Military Installations
    STATEFIP == 99 ~ NA #redundant now
  )) 

#remove og STATEFIP var? drop other vars?

#label legalization date from Gerstmann 2012 OG pqper (see issues)
gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = NA) %>%
  mutate(date_legalization = case_when ( 
    state_name == "AL" ~ 2015,
    state_name == "AK" ~ 2014,
    state_name == "AZ" ~ 2014,
    state_name == "AR" ~ 2015,
    state_name == "CA" ~ 2013, #watch leglized/repealed issue
    state_name == "CO" ~ 2014,
    state_name == "CT" ~ 2008,
    state_name == "DE" ~ 2013,
    state_name == "DC" ~ 2009,
    state_name == "FL" ~ 2015)) 

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when(
    state_name == "GA" ~ 2015,
    state_name == "HI" ~ 2013,
    state_name == "ID" ~ 2014,
    state_name == "IL" ~ 2013,
    state_name == "IN" ~ 2014,
    state_name == "IA" ~ 2009,
    state_name == "KS" ~ 2014,
    state_name == "KY" ~ 2015,
    state_name == "LA" ~ 2015,
    state_name == "ME" ~ 2012)) 

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when(
    state_name == "MD" ~ 2012,
    state_name == "MA" ~ 2003,
    state_name == "MI" ~ 2015,
    state_name == "MN" ~ 2013,
    state_name == "MS" ~ 2015,
    state_name == "MO" ~ 2015,
    state_name == "MT" ~ 2014,
    state_name == "NE" ~ 2015,
    state_name == "NV" ~ 2014,
    state_name == "NH" ~ 2009)) 

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when(
    state_name == "NJ" ~ 2013,
    state_name == "NM" ~ 2013,
    state_name == "NY" ~ 2011,
    state_name == "NC" ~ 2014,
    state_name == "ND" ~ 2015,
    state_name == "OH" ~ 2015,
    state_name == "OK" ~ 2014,
    state_name == "OR" ~ 2014,
    state_name == "PA" ~ 2014,
    state_name == "RI" ~ 2013)) 

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when(
    state_name == "SC" ~ 2014,
    state_name == "SD" ~ 2015,
    state_name == "TN" ~ 2015,
    state_name == "TX" ~ 2015,
    state_name == "UT" ~ 2014,
    state_name == "VT" ~ 2009,
    state_name == "VA" ~ 2014,
    state_name == "WA" ~ 2012,
    state_name == "WV" ~ 2014,
    state_name == "WI" ~ 2014,
    state_name == "WY" ~ 2014,
    state_name == "PR" ~ 2015, #from googling
    state_name == "OMI" ~ 2015 #from guessing
  ))


#make time_since variable
gc()
df_samesex <- df_samesex %>%
  mutate(time_since_legalization = YEAR - date_legalization) 

```

Make dummies for analysis based on time_since_legalization (other methods possible with different packages?)
```{r, include = F}
gc()
?model_matrix #concerned... actually make matrix

#other options
#if_else method
#fastDummies library + dummy_cols()

```
Other data cleaning - watch weights see above for right variable - watch NAs too

REMEMBER WEIGHTS AND IGNORE ERROR MESSAGES

Summary statistics

Initial Regression