---
title: "data_cleaning"
output: html_document

---
Load packages
```{r, include = F}
gc()
library(tidyverse) #for data work
library(data.table) #for data loading
library(haven) #for writing to dta
library(readxl) #for reading in FRED data
#watch these packages for dummies
install.packages("fastDummies") # --- recipes package might also work or tidymodels? (step_dummy maybe work darn recipe use confusion) (or not- different method) - issue: combo 2 years - check
library(fastDummies)
```

Download IPUMS data
```{r, include = F}
gc()

pull1_csv <- fread("C:\\Users\\njrich\\Downloads\\pull1.csv")

#note might need to redownload to factor in ASECWT weights - watch individual v household serial and rules of weights - questions about ASECWT only in IPUMS CPS maybe also widow var... hmm.....
```

Select out unneeded variables
```{r, include = F}
gc()
pull1_csv <- pull1_csv %>%
  select(-SAMPLE, -CBSERIAL, -HHWT, -CLUSTER, -STRATA, -GQ)

#note: need to add ASECWT weight var after looking

```

Identify individuals in same-sex relationships (with weights)  
```{r, include = F}
gc()
partner <- pull1_csv %>%
  select(YEAR, SERIAL, PERNUM, SEX) 

gc()
df_partners <- pull1_csv %>%
  left_join(partner, join_by(YEAR, SERIAL, SPLOC == PERNUM), suffix = c(".indv", ".partner"))

gc()
df_samesex <- df_partners %>% #WATCH CLARITY WHERE SPLOC IS
  mutate(in_samesex = case_when(
    (SEX.indv == 1) & (SEX.partner == 1) ~ 1, #gay
    (SEX.indv == 2) & (SEX.partner == 2) ~ 1, #gay
    (SEX.indv == 2) & (SEX.partner == 1) ~ 0, #straight
    (SEX.indv == 1) & (SEX.partner == 2) ~ 0, #straight
    (SEX.indv == 9) | (SEX.partner == 9) ~ NA #NA 
  )) %>%
  mutate(in_samesex_weighted = in_samesex * PERWT) #NOTE: I AM NOT SURE IF THIS IS CORRECT METHOD, SE OFF NOT ADJUSTED

rm(partner, df_partners, pull1_csv)
#PUT IN PERWT HERE WATCH NEED DIVIDE BY 100 AND GET DECIMALS            
```

Label states/input legalization year/length of time since legalization (use FIP) 

```{r, include = F}

#label states
gc()
df_samesex <- df_samesex %>%
  mutate(state_name = as.character(STATEFIP)) #better way to do this- see 309 notes too? (fixing state_name=NA issue)

df_samesex <- df_samesex %>% #ok this seems to work
  mutate(state_name = case_when( 
    state_name == "1" ~ "AL",
    state_name == "2" ~ "AK",
    state_name == "4" ~ "AZ",
    state_name == "5" ~ "AR",
    state_name == "6" ~ "CA",
    state_name == "8" ~ "CO",
    state_name == "9" ~ "CT",
    state_name == "10" ~ "DE",
    TRUE ~ state_name))

gc()
df_samesex <- df_samesex %>%
  mutate(state_name = case_when(
    state_name == "11" ~ "DC",
    state_name == "12" ~ "FL",
    state_name == "13" ~ "GA",
    state_name == "15" ~ "HI",
    state_name == "16" ~ "ID",
    state_name == "17" ~ "IL",
    state_name == "18" ~ "IN",
    state_name == "19" ~ "IA",
    state_name == "20" ~ "KS",
    TRUE ~ state_name)) 

gc()
df_samesex <- df_samesex %>%
  mutate(state_name = case_when(
    state_name == "21" ~ "KY",
    state_name == "22" ~ "LA",
    state_name == "23" ~ "MI",
    state_name == "24" ~ "MD",
    state_name == "25" ~ "MA",
    state_name == "26" ~ "ME",
    state_name == "27" ~ "MN",
    state_name == "28" ~ "MS",
    state_name == "29" ~ "MO",
    state_name == "30" ~ "MT",
    TRUE ~ state_name)) 

gc()
df_samesex <- df_samesex %>%
  mutate(state_name = case_when(
    state_name == "31" ~ "NE",
    state_name == "32" ~ "NV",
    state_name == "33" ~ "NH",
    state_name == "34" ~ "NJ",
    state_name == "35" ~ "NM",
    state_name == "36" ~ "NY",
    state_name == "37" ~ "NC",
    state_name == "38" ~ "ND",
    state_name == "39" ~ "OH",
    state_name == "40" ~ "OK",
    TRUE ~ state_name)) 

gc()
df_samesex <- df_samesex %>% #this seems to be the only clause that works...
  mutate(state_name = case_when(
    state_name == "41" ~ "OR",
    state_name == "42" ~ "PA",
    state_name == "44" ~ "RI",
    state_name == "45" ~ "SC",
    state_name == "46" ~ "SD",
    state_name == "47" ~ "TN",
    state_name == "48" ~ "TX",
    state_name == "49" ~ "UT",
    state_name == "50" ~ "VT",
    state_name == "51" ~ "VA",
    state_name == "53" ~ "WA",
    state_name == "54" ~ "WV",
    state_name == "55" ~ "WI",
    state_name == "56" ~ "WY",
    state_name == "72" ~ "PR",
    state_name == "97" ~ "OMI", #Overseas Military Installations
    state_name == "99" ~ NA,
    TRUE ~ state_name 
  )) 



#label legalization date from Gerstmann "2012" OG pqper (see issues)
gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = state_name) 

df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when ( 
    date_legalization == "AL" ~ "2015",
    date_legalization == "AK" ~ "2014",
    date_legalization == "AZ" ~ "2014",
    date_legalization == "AR" ~ "2015",
    date_legalization == "CA" ~ "2013", #watch legalized/repealed issue
    date_legalization == "CO" ~ "2014",
    date_legalization == "CT" ~ "2008",
    date_legalization == "DE" ~ "2013",
    date_legalization == "DC" ~ "2009",
    date_legalization == "FL" ~ "2015",
    TRUE ~ date_legalization)) 

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when(
    date_legalization == "GA" ~ "2015",
    date_legalization == "HI" ~ "2013",
    date_legalization == "ID" ~ "2014",
    date_legalization == "IL" ~ "2013",
    date_legalization == "IN" ~ "2014",
    date_legalization == "IA" ~ "2009",
    date_legalization == "KS" ~ "2014",
    date_legalization == "KY" ~ "2015",
    date_legalization == "LA" ~ "2015",
    date_legalization == "ME" ~ "2012",
    TRUE ~ date_legalization)) 

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when(
    date_legalization == "MD" ~ "2012",
    date_legalization == "MA" ~ "2003",
    date_legalization == "MI" ~ "2015",
    date_legalization == "MN" ~ "2013",
    date_legalization == "MS" ~ "2015",
    date_legalization == "MO" ~ "2015",
    date_legalization == "MT" ~ "2014",
    date_legalization == "NE" ~ "2015",
    date_legalization == "NV" ~ "2014",
    date_legalization == "NH" ~ "2009",
    TRUE ~ date_legalization)) 

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when(
    date_legalization == "NJ" ~ "2013",
    date_legalization == "NM" ~ "2013",
    date_legalization == "NY" ~ "2011",
    date_legalization == "NC" ~ "2014",
    date_legalization == "ND" ~ "2015",
    date_legalization == "OH" ~ "2015",
    date_legalization == "OK" ~ "2014",
    date_legalization == "OR" ~ "2014",
    date_legalization == "PA" ~ "2014",
    date_legalization == "RI" ~ "2013",
    TRUE ~ date_legalization)) 

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = case_when(
    date_legalization == "SC" ~ "2014",
    date_legalization == "SD" ~ "2015",
    date_legalization == "TN" ~ "2015",
    date_legalization == "TX" ~ "2015",
    date_legalization == "UT" ~ "2014",
    date_legalization == "VT" ~ "2009",
    date_legalization == "VA" ~ "2014",
    date_legalization == "WA" ~ "2012",
    date_legalization == "WV" ~ "2014",
    date_legalization == "WI" ~ "2014",
    date_legalization == "WY" ~ "2014",
    date_legalization == "PR" ~ "2015", #from googling
    date_legalization == "OMI" ~ "2015", #from guessing
    TRUE ~ date_legalization 
  ))

gc()
df_samesex <- df_samesex %>%
  mutate(date_legalization = as.numeric(date_legalization))

#make time_since variable
gc()
df_samesex <- df_samesex %>%
  mutate(time_since_legalization = if_else(YEAR - date_legalization < 0, NA, YEAR - date_legalization)) #check if this makes sense

#save output of this somewhere for ease of use?

```

Filter/sort data to match MarcÃ©n/Morales target population
```{r, include = F}
gc()

```

Create state pop table for pop weighting (NOTE: this code is for reading in from personal MAC, not UGLI computer)
```{r, include = F}
gc()
state_pop <- read_excel("/Users/njrich/Desktop/Econ495/same-sex-migration/Data/FRED_statepops/STATEPOP.xls", sheet = "Annual")

#match up columns
state_pop <- state_pop %>%
  pivot_longer(AKPOP:WYPOP, names_to = "state_name") %>%
  rename("POP" = "value") 

#match up strings
state_pop <- state_pop %>%
  mutate(state_name = str_remove(state_name, "POP")) %>%
  mutate(DATE = as.character(DATE)) %>%
  mutate(DATE = str_remove(DATE, "-01-01")) %>%
  mutate(DATE = as.numeric(DATE)) %>%
  mutate(POP = as.character(POP)) %>%
  mutate(POP = str_remove(POP, "\\.")) %>%
  mutate(POP = as.numeric(POP)) 

```



Make pct same-sex by state and year var (see weighting/exclusions) - MERGE THIS BACK/THINK BETTER WAY? --turn this into function?
```{r, include = F}
gc()

#find pcts
samesex_staterate <- df_samesex %>%
  filter(!is.na(MIGPLAC1)) %>% #get interstate migrants only
  group_by(YEAR, state_name) %>%
  summarize(samesex_state_count = sum(in_samesex_weighted, na.rm = T)) %>% #note: weight implementation means SE unreliable
  ungroup() %>%
  group_by(YEAR) %>%
  mutate(year_totals = sum(samesex_state_count)) %>%
  ungroup() %>%
  mutate(staterate_year = samesex_state_count/year_totals) %>%
  select(YEAR, state_name, staterate_year)

#ID key variables to merge back in
extra_variables <- df_samesex %>% 
  distinct(YEAR, state_name, time_since_legalization)

#merge back in - think about implications of extra_variables having extra rows relative to state rate

cleaned_data <- samesex_staterate %>%
  left_join(extra_variables, join_by(YEAR, state_name)) %>%
  left_join(state_pop, join_by(YEAR, state_name))


#****add in state-level controls#


rm(samesex_staterate, extra_variables, state_pop)
```

Export cleanish data for code testing purposes
```{r, include = F}
gc()
write.csv(samesex_staterate_cleanish, "C:\\Users\\njrich\\Desktop\\same-sex-migration\\test_regression_data.csv")
write_dta(samesex_staterate_cleanish, "C:\\Users\\njrich\\Desktop\\same-sex-migration\\test_regression_data.dta")

```

Make dummies/do analysis
```{r, include = F}
#USE WOLFERS CODE

```
Other data cleaning - STATE POPULATION INCLUDE!! (:( more merging data sets)

Initial Regression