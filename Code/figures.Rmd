---
title: "figures"
output: html_document
date: "2024-12-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages (now many unnecessary)
```{r, include = F}
gc()
library(data.table) #for data loading
library(tidyverse) #for data work
install.packages("janitor")
library(janitor) #for clean_names
install.packages("srvyr")
library(srvyr) #for weighting
library(haven) #for reading in dta

install.packages("kableExtra") #to make more complicated output tables for LATEX
library(kableExtra)

install.packages("jtools") #for ggplot visualization
library(jtools)
```

Download clean data
```{r, include = F}
gc()
#windows
# clean_df <- read_dta("C:\\Users\\njrich\\Downloads\\clean_dataframe.dta") %>%
#   clean_names() %>% 
#   mutate(across(where(is.labelled), ~ as.character(as_factor(.)))) #hopefully this doesn't break things
#mac
clean_df <- read_dta("/Users/njrich/Downloads/clean_dataframe.dta") %>%
  clean_names() %>% 
  mutate(across(where(is.labelled), ~ as.character(as_factor(.))))

```

Make survey object
```{r, include = F}
gc()

summary_stats <- as_survey(clean_df, weights = perwt) #note: exclude rep_wts so standard errors are inaccurate (file otherwise insanely big- talk someone about it)

```

Summary stats - general population (will need to do a lot of work to functionalize and combine in logical way- think about categories of table types) 
```{r, include = F}
gc()
#count those in/not in same sex
count_samesex <- summary_stats %>%
  group_by(year) %>%
  summarize(prop_samesex = survey_mean(in_samesex, na.rm = T)) %>%
  select(-prop_samesex_se)

#need to recreate variables for this
gc()
#count prop in legal same-sex state/not:
# count_in_legal <- summary_stats %>%
#   group_by(year) %>%
#   summarize(prop_in_legal = survey_mean(expost_legal_state, na.rm = T)) %>%
#   select(-prop_in_legal_se) 

###

gc()
#count male/female - think about if need this
count_male_female <- summary_stats %>%
  mutate(sex = ifelse(sex == 9, NA, sex - 1)) %>%
  group_by(year) %>%
  summarize(prop_fem = survey_mean(sex, na.rm = T)) %>%
  select(-prop_fem_se)

gc()
#count prop in post_old_legal state/not (with old_legal definition):
count_in_old_legal <- summary_stats %>%
  group_by(year) %>%
  summarize(prop_in_old_legal = survey_mean(expost_old_legal, na.rm = T)) %>%
  select(-prop_in_old_legal_se)

gc()
#create joint table
joint_overall_table <- count_male_female %>%
  left_join(count_samesex, by = "year") %>%
  left_join(count_in_old_legal, by = "year") %>%
  setNames(c("Year", "%/100 Female", "%/100 Same-Sex", "%/100 in Locally Legalized States")) %>%
  kable(caption = "Summary Statistics for Overall Population", format = "latex", booktabs = T, digits = 3) 

#export joint table
writeLines(joint_overall_table, "/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/overall_table.tex") #NOTE: THIS IS FOR MAC, WILL NEED TO ADJUST FOR WINDOWS

#note frac v percent
```

Summary stats - for controls (will need to do a lot of work to functionalize and combine in logical way- think about categories of table types) (need to add children count)
```{r, include = F}

gc()
#count male/female among those in same-sex relationships
prop_fem_samesex <- summary_stats %>%
  mutate(sex = ifelse(sex == 9, NA, sex - 1)) %>%
  group_by(year, in_samesex) %>%
  summarize(prop_fem = survey_mean(sex, na.rm = T)) %>%
  select(-prop_fem_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Sex", "Opposite-Sex Sex")) %>%
  pivot_wider(names_from = in_samesex, values_from = prop_fem) %>%
  select(year, "Same-Sex Sex", "Opposite-Sex Sex")

gc()
#fraction with children table
#need to import variables for this

gc()
#mean age by same-sex/opposite-sex weighted, by year
mean_age_samesex <- summary_stats %>%
  group_by(year, in_samesex) %>%
  summarize(mean_age = survey_mean(age, na.rm = T)) %>%
  select(-mean_age_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Age", "Opposite-Sex Age")) %>%
  pivot_wider(names_from = in_samesex, values_from = mean_age) %>%
  select(year, "Same-Sex Age", "Opposite-Sex Age")

gc()
#fraction >=4 years college attainment by same-sex/opposite-sex weighted, by year
frac_college_samesex <- summary_stats %>%
  mutate(four_years_college = ifelse(educ >= 10, 1, 0)) %>%
  group_by(year, in_samesex) %>%
  summarize(frac_college = survey_mean(four_years_college, na.rm = T)) %>%
  select(-frac_college_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex College", "Opposite-Sex College")) %>%
  pivot_wider(names_from = in_samesex, values_from = frac_college) %>%
  select(year, "Same-Sex College", "Opposite-Sex College")

gc()
#fraction white by same-sex/opposite-sex weighted, by year
frac_white_samesex <- summary_stats %>%
  mutate(white = ifelse(race == 1, 1, 0)) %>%
  group_by(year, in_samesex) %>%
  summarize(frac_white = survey_mean(white, na.rm = T)) %>%
  select(-frac_white_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex White", "Opposite-Sex White")) %>%
  pivot_wider(names_from = in_samesex, values_from = frac_white)  %>%
  select(year, "Same-Sex White", "Opposite-Sex White")

gc()
#mean income by same-sex/opposite-sex weighted, by year
mean_income_samesex <- summary_stats %>%
  group_by(year, in_samesex) %>%
  summarize(mean_income = survey_mean(inctot, na.rm = T)) %>%
  select(-mean_income_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Inc", "Opposite-Sex Inc")) %>%
  pivot_wider(names_from = in_samesex, values_from = mean_income) %>%
  select(year, "Same-Sex Inc", "Opposite-Sex Inc")

#frac have children by same-sex/opposite-sex weighted, by year
frac_child_samesex <- summary_stats %>%
  group_by(year, in_samesex) %>%
  summarize(frac_child = survey_mean(has_child, na.rm = T)) %>%
  select(-frac_child_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Child", "Opposite-Sex Child")) %>%
  pivot_wider(names_from = in_samesex, values_from = frac_child) %>%
  select(year, "Same-Sex Child", "Opposite-Sex Child")


gc()
#create joint table
joint_control_table <- prop_fem_samesex %>%
  left_join(mean_age_samesex, by = "year") %>%
  left_join(frac_college_samesex, by = "year") %>%
  left_join(frac_white_samesex, by = "year") %>%
  left_join(mean_income_samesex, by = "year") %>%
  left_join(frac_child_samesex, by = "year") %>%
  setNames(c("Year", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex")) %>% #needs work
  kable(caption = "Summary Statistics for Proposed Controls", format = "latex", booktabs = T, digits = 3) %>%
  add_header_above(c(" " = 1, "%/100 Female" = 2, "Mean Age" = 2, "%/100 College" = 2, "%/100 White" = 2, "Mean Income" = 2, "%/100 Has Child" = 2))

#export joint table
writeLines(joint_control_table, "/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/control_table.tex") #NOTE: THIS IS FOR MAC, WILL NEED TO ADJUST FOR WINDOWS

#watch column arranging
```

Summary stats - stock migrants/general pops. in certain state categories (deprecate)
```{r, include = F}
# #oop count labeling not super accurate
# 
# gc()
# #count prop by same_sex in post_old_legal state/not (with old_legal definition):
# count_samesex_in_old_legal <- summary_stats %>%
#   group_by(year, in_samesex) %>%
#   summarize(prop_in_old_legal = survey_mean(expost_old_legal, na.rm = T)) %>%
#   select(-prop_in_old_legal_se) %>%
#   mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex in Old Legal", "Opposite-Sex in Old Legal")) %>%
#   pivot_wider(names_from = in_samesex, values_from = prop_in_old_legal) %>%
#   select(year, "Same-Sex in Old Legal", "Opposite-Sex in Old Legal")
# 
# gc()
# #count prop migrants by same_sex in post_old_legal state/not (with old_legal definition):
# count_samesex_migrants_in_old_legal <- summary_stats %>%
#   filter(migrant == 1) %>%
#   group_by(year, in_samesex) %>%
#   summarize(prop_in_old_legal = survey_mean(expost_old_legal, na.rm = T)) %>%
#   select(-prop_in_old_legal_se) %>%
#   mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Migrants in Old Legal", "Opposite-Sex Migrants in Old Legal")) %>%
#   pivot_wider(names_from = in_samesex, values_from = prop_in_old_legal) %>%
#   select(year, "Same-Sex Migrants in Old Legal", "Opposite-Sex Migrants in Old Legal")
# 
# gc()
# #subtracted expost trends table
# subtracted_trends_post <- count_samesex_migrants_in_old_legal %>%
#   mutate(subtracted_trends_post = `Same-Sex Migrants in Old Legal` - `Opposite-Sex Migrants in Old Legal`) %>%
#   select(year, subtracted_trends_post)
# 
# gc()
# #count prop by same_sex from post_old_legal state/not (with old_legal definition):
# count_samesex_from_old_legal <- summary_stats %>%
#   group_by(year, in_samesex) %>%
#   summarize(prop_from_old_legal = survey_mean(exante_old_legal, na.rm = T)) %>%
#   select(-prop_from_old_legal_se) %>%
#   mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex from Old Legal", "Opposite-Sex from Old Legal")) %>%
#   pivot_wider(names_from = in_samesex, values_from = prop_from_old_legal) %>%
#   select(year, "Same-Sex from Old Legal", "Opposite-Sex from Old Legal")
# 
# gc()
# #count prop migrants by same_sex in post_old_legal state/not (with old_legal definition):
# count_samesex_migrants_from_old_legal <- summary_stats %>%
#   filter(migrant == 1) %>%
#   group_by(year, in_samesex) %>%
#   summarize(prop_from_old_legal = survey_mean(exante_old_legal, na.rm = T)) %>%
#   select(-prop_from_old_legal_se) %>%
#   mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Migrants from Old Legal", "Opposite-Sex Migrants from Old Legal")) %>%
#   pivot_wider(names_from = in_samesex, values_from = prop_from_old_legal)
# 
# gc()
# #subtracted exante trends table
# subtracted_trends_ante <- count_samesex_migrants_from_old_legal %>%
#   mutate(subtracted_trends_ante = `Same-Sex Migrants from Old Legal` - `Opposite-Sex Migrants from Old Legal`) %>%
#   select(year, subtracted_trends_ante)
# 
# gc()
# #create joint table
# joint_location_table <- count_samesex_in_old_legal %>%
#   left_join(count_samesex_migrants_in_old_legal, by = "year") %>%
#   left_join(subtracted_trends_post, by = "year") %>%
#   left_join(count_samesex_from_old_legal, by = "year") %>%
#   left_join(count_samesex_migrants_from_old_legal, by = "year") %>%
#   left_join(subtracted_trends_ante, by = "year") %>%
#   setNames(c("Year", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Difference", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Difference")) %>% #needs work
#   kable(caption = "Individuals by Location", format = "latex", booktabs = T, digits = 3) %>%
#   add_header_above(c(" " = 1, "In Locally Legalized" = 2, "Migrants in Locally Legalized" = 2, " " = 1, "In from Locally Legalized" = 2, "Migrants from Locally Legalized" = 2, " " = 1)) 
# 
# #export joint table
# writeLines(joint_location_table, "/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/locations_table.tex") #NOTE: THIS IS FOR MAC, WILL NEED TO ADJUST FOR WINDOWS
# 
# #need to abbreviate some titles
```

Summary statistics/trends table for regression storytelling
```{r, include = F}
gc()
#ex-post
#df
post_migrant_trends_df <- summary_stats %>%
  mutate(subgroup = case_when(
    in_samesex == 1 & expost_old_legal == 1 ~ "samesex_oldlegal",
    in_samesex == 0 & expost_old_legal == 1 ~ "oppositesex_oldlegal",
    in_samesex == 1 & expost_old_legal == 0 ~ "samesex_newlegal",
    in_samesex == 0 & expost_old_legal == 0 ~ "oppositesex_newlegal"
  )) %>%
  group_by(year, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) 

#table for export
post_migrant_trendsdiffs_table <- post_migrant_trends_df %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  select(year, samesex_oldlegal, samesex_newlegal, samesex_diff, oppositesex_oldlegal, oppositesex_newlegal, oppositesex_diff)


#trends chart for export
gc()
post_migrant_trends_chart <- post_migrant_trends_df %>%
  ggplot() +
    geom_line(aes(x = year, y = frac_migrate, linetype = subgroup)) + 
    labs(title = "Ex-Post Trends Visualized",
         x = "Year",
         y = "Fraction Migrated",
         linetype = "Subgroup") + #maybe move title to plot itself
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + #bc factor issues
    scale_linetype_manual(values = c("samesex_oldlegal" = "solid", "oppositesex_oldlegal" = "dotted", "samesex_newlegal" = "longdash", "oppositesex_newlegal" = "dotdash"),
                     labels = c("samesex_oldlegal" = "Same-Sex Individuals in Locally Legalized States", "oppositesex_oldlegal" = "Opposite-Sex Individuals in Locally Legalized States", "samesex_newlegal" = "Same-Sex Individuals in Federally Legalized States", "oppositesex_newlegal" = "Opposite-Sex Individuals in Federally Legalized States")) +
  scale_x_continuous(breaks = 2011:2019) +
  theme_apa() #can always go back to theme

post_migrant_trends_chart

#diffs chart for export
gc()
post_migrant_diffs_chart <- post_migrant_trendsdiffs_table %>%
  select(year, samesex_diff, oppositesex_diff) %>%
  pivot_longer(cols = c(samesex_diff, oppositesex_diff), names_to = "subgroup", values_to= "diffs") %>%
  ggplot() +
    geom_line(aes(x = year, y = diffs, linetype = subgroup)) + 
    labs(title = "Ex-Post Triple Regression Visualized",
         x = "Year",
         y = "Migration to Locally - Federally Legalized States",
         linetype = "Subgroup") + #maybe move title to plot itself
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + #bc factor issues
    scale_linetype_manual(values = c("samesex_diff" = "solid", "oppositesex_diff" = "dashed"),
                     labels = c("samesex_diff" = "Same-Sex Individuals", "oppositesex_diff" = "Opposite-Sex Individuals")) +
  scale_x_continuous(breaks = 2011:2019) +
  theme_apa() #can always go back to theme

post_migrant_diffs_chart

#ante
#df
ante_migrant_trends_df <- summary_stats %>%
  mutate(subgroup = case_when(
    in_samesex == 1 & exante_old_legal == 1 ~ "samesex_oldlegal",
    in_samesex == 0 & exante_old_legal == 1 ~ "oppositesex_oldlegal",
    in_samesex == 1 & exante_old_legal == 0 ~ "samesex_newlegal",
    in_samesex == 0 & exante_old_legal == 0 ~ "oppositesex_newlegal"
  )) %>%
  group_by(year, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) 

#table for export
ante_migrant_trendsdiffs_table <- ante_migrant_trends_df %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  select(year, samesex_oldlegal, samesex_newlegal, samesex_diff, oppositesex_oldlegal, oppositesex_newlegal, oppositesex_diff)

#trends chart for export
gc()
ante_migrant_trends_chart <- ante_migrant_trends_df %>%
  ggplot() +
    geom_line(aes(x = year, y = frac_migrate, linetype = subgroup)) +
  labs(title = "Ex-Ante Trends Visualized",
        x = "Year",
        y = "Fraction Migrated",
        linetype = "Subgroup") +
  geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + #bc factor issues
  scale_linetype_manual(values = c("samesex_oldlegal" = "solid", "oppositesex_oldlegal" = "dotted", "samesex_newlegal" = "longdash", "oppositesex_newlegal" = "dotdash"),
                     labels = c("samesex_oldlegal" = "Same-Sex Individuals in Locally Legalized States", "oppositesex_oldlegal" = "Opposite-Sex Individuals in Locally Legalized States", "samesex_newlegal" = "Same-Sex Individuals in Federally Legalized States", "oppositesex_newlegal" = "Opposite-Sex Individuals in Federally Legalized States")) +
  scale_x_continuous(breaks = 2011:2019) +
  theme_apa()

ante_migrant_trends_chart

#diffs chart for export
gc()
ante_migrant_diffs_chart <- ante_migrant_trendsdiffs_table %>%
  select(year, samesex_diff, oppositesex_diff) %>%
  pivot_longer(cols = c(samesex_diff, oppositesex_diff), names_to = "subgroup", values_to= "diffs") %>%
  ggplot() +
    geom_line(aes(x = year, y = diffs, linetype = subgroup)) + 
    labs(title = "Ex-Ante Triple Regression Visualized",
         x = "Year",
         y = "Migration to Locally - Federally Legalized States",
         linetype = "Subgroup") + #maybe move title to plot itself
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + #bc factor issues
    scale_linetype_manual(values = c("samesex_diff" = "solid", "oppositesex_diff" = "dashed"),
                     labels = c("samesex_diff" = "Same-Sex Individuals", "oppositesex_diff" = "Opposite-Sex Individuals")) +
  scale_x_continuous(breaks = 2011:2019) +
  theme_apa() #can always go back to theme

ante_migrant_diffs_chart


#export charts
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/post_trends.png", plot = post_migrant_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/post_diffs.png", plot = post_migrant_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/ante_trends.png", plot = ante_migrant_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/ante_diffs.png", plot = ante_migrant_diffs_chart)


#export joint table
joint_trendsdiffs_table <- post_migrant_trendsdiffs_table %>%
  left_join(ante_migrant_trendsdiffs_table, by = "year") %>% 
  setNames(c("Year", "Locally Legalized", "Federally Legalized", "Difference", "Locally Legalized", "Federally Legalized", "Difference", "Locally Legalized", "Federally Legalized", "Difference", "Locally Legalized", "Federally Legalized", "Difference")) %>%
  kable(caption = "Migration Trends Data", format = "latex", booktabs = T, digits = 3) %>%
  add_header_above(c(" " = 1, "Same-Sex" = 2, " " = 1, "Opposite-Sex" = 2, " " = 1, "Same-Sex" = 2, " " = 1, "Opposite-Sex" = 2, " " = 1))  %>% #hmm reorganize to make more sense?
  add_header_above(c(" " = 1, "Fraction Moving To" = 6, "Fraction Moving From" = 6))

writeLines(joint_trendsdiffs_table, "/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/trendsdiffs_table.tex")
gc()
#oop functionalize
#watch issues with code, better labeling and organization
#separate these boxes?
#discrepancies in plots to test

#for charts to look good, just take screenshots at the moment
```

Flow tables (oop ig should do diffs)/functionalize
```{r, include = F}
gc()

#from locally legalized same-sex sample
from_local_df <- summary_stats %>%
  filter(exante_old_legal == 1) %>%
  group_by(year, in_samesex) %>%
  summarize(frac_to_diff_local = survey_mean(localtolocal_migrant, na.rm = T),
            frac_to_fed = survey_mean(localtofed_migrant, na.rm = T),
            frac_stay = 1 - survey_mean(migrant, na.rm = T)) %>% #watch how filtering impacts mean-ing here
  select(-frac_to_diff_local_se, -frac_to_fed_se, -frac_stay_se) %>%
  mutate(samesex_group = if_else(in_samesex == 1, "same_sex", "opposite_sex")) %>%
  ungroup()
   
gc()
from_local_trends_chart <- from_local_df %>%  
  pivot_longer(frac_to_diff_local:frac_stay, names_to = "category", values_to = "values") %>%
    ggplot() +
    geom_line(aes(x = year, y = values, linetype = samesex_group)) + 
    labs(title = "From Locally Legalized Trends Visualized",
         x = "Year",
         y = "Fraction of Population",
         linetype = "Relationship Type") + #maybe move title to plot itself
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + 
    scale_linetype_manual(values = c("same_sex" = "solid", "opposite_sex" = "dashed"),
                     labels = c("same_sex" = "In Same-Sex Relationship", "opposite_sex" = "In Opposite-Sex Relationship")) +
  scale_x_continuous(breaks = 2011:2019) +
  facet_wrap(~ category, labeller = as_labeller(c("frac_to_diff_local" = "To Other Locally Legalized State", "frac_to_fed" = "To Not/Fed Legalized State", "frac_stay" = "To Same State"))) +
  theme_apa() #can always go back to theme
gc()
from_local_diffs_chart <- from_local_df %>%
  pivot_longer(frac_to_diff_local:frac_stay, names_to = "category", values_to = "values") %>%
  select(-in_samesex) %>%
  pivot_wider(names_from = samesex_group, values_from = values) %>%
  mutate(ss_os = same_sex - opposite_sex) %>%
  ggplot() +
    geom_line(aes(x = year, y = ss_os)) + 
    labs(title = "From Locally Legalized Diffs Visualized",
         x = "Year",
         y = "Fraction Same-Sex - Opposite-Sex") + #NOTE HOW THIS INTERPRETATION LINES UP WITH ABOVE INTERPRETATION OOPS- actually might be good just take it another step further
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") +
  scale_x_continuous(breaks = 2011:2019) +
  facet_wrap(~ category, labeller = as_labeller(c("frac_to_diff_local" = "To Other Locally Legalized State", "frac_to_fed" = "To Not/Fed Legalized State", "frac_stay" = "To Same State"))) +
  theme_apa() #can always go back to theme

gc()
#from not/federally legalized same-sex sample
from_fed_df <- summary_stats %>%
  filter(exante_old_legal == 0) %>%
  group_by(year, in_samesex) %>%
  summarize(frac_to_diff_fed = survey_mean(fedtofed_migrant, na.rm = T),
            frac_to_local = survey_mean(fedtolocal_migrant, na.rm = T),
            frac_stay = 1 - survey_mean(migrant, na.rm = T)) %>% #watch how filtering impacts mean-ing here
  select(-frac_to_diff_fed_se, -frac_to_local_se, -frac_stay_se) %>%
  mutate(samesex_group = if_else(in_samesex == 1, "same_sex", "opposite_sex")) %>%
  ungroup()
   
gc()
from_fed_trends_chart <- from_fed_df %>%  
  pivot_longer(frac_to_diff_fed:frac_stay, names_to = "category", values_to = "values") %>%
    ggplot() +
    geom_line(aes(x = year, y = values, linetype = samesex_group)) + 
    labs(title = "From Not/Federally Legalized Trends Visualized",
         x = "Year",
         y = "Fraction of Population",
         linetype = "Relationship Type") + #maybe move title to plot itself
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + 
    scale_linetype_manual(values = c("same_sex" = "solid", "opposite_sex" = "dashed"),
                     labels = c("same_sex" = "In Same-Sex Relationship", "opposite_sex" = "In Opposite-Sex Relationship")) +
  scale_x_continuous(breaks = 2011:2019) +
  facet_wrap(~ category, labeller = as_labeller(c("frac_to_diff_fed" = "To Other Not/Federally Legalized State", "frac_to_local" = "To Locally Legalized State", "frac_stay" = "To Same State"))) +
  theme_apa() #can always go back to theme
gc()
from_fed_diffs_chart <- from_fed_df %>%
  pivot_longer(frac_to_diff_fed:frac_stay, names_to = "category", values_to = "values") %>%
  select(-in_samesex) %>%
  pivot_wider(names_from = samesex_group, values_from = values) %>%
  mutate(ss_os = same_sex - opposite_sex) %>%
  ggplot() +
    geom_line(aes(x = year, y = ss_os)) + 
    labs(title = "From Not/Federally Legalized Diffs Visualized",
         x = "Year",
         y = "Fraction Same-Sex - Opposite-Sex") + #NOTE HOW THIS INTERPRETATION LINES UP WITH ABOVE INTERPRETATION OOPS- actually might be good just take it another step further
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") +
  scale_x_continuous(breaks = 2011:2019) +
  facet_wrap(~ category, labeller = as_labeller(c("frac_to_diff_fed" = "To Other Not/Federally Legalized State", "frac_to_local" = "To Locally Legalized State", "frac_stay" = "To Same State"))) +
  theme_apa() #can always go back to theme

gc()
#export
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/from_local_trends.png", plot = from_local_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/from_local_diffs.png", plot = from_local_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/from_fed_trends.png", plot = from_fed_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/from_fed_diffs.png", plot = from_fed_diffs_chart)


#watch diffs v general flows oi vey
#oop functionalize
#watch change in meaning of outcome variables when splitting things up
#watch diff btwn local to local migrant v stay in state
#oi watch how do this in a regression
#just break in two and look at migration rates?
#is staying the same moving to a state of the same type
#lol make sure numbers add up to 1
#oop dashed v dotted
#WATCH DEFINITIONS FEDERALLY LEGALIZED A BIT AMBIGUOUS
#oopsy efficiencies
#sigh moving slowly
#WATCH INTERPRETATION FAKE OUTS- actually might be good just take it another step further
#I wonder what controlling for distance would do
#this maybe lines up a bit more with predictions but not really

#observations
#some impact fed to fed in direction that makes sense
```

Other Heterogeneity Charts (Think about if want tables)... sigh functionalizing
```{r, include = F}
gc()
#make dfs
post_migrant_trends_df <- summary_stats %>%
  mutate(subgroup = case_when(
    in_samesex == 1 & expost_old_legal == 1 ~ "samesex_oldlegal",
    in_samesex == 0 & expost_old_legal == 1 ~ "oppositesex_oldlegal",
    in_samesex == 1 & expost_old_legal == 0 ~ "samesex_newlegal",
    in_samesex == 0 & expost_old_legal == 0 ~ "oppositesex_newlegal"
  ))

ante_migrant_trends_df <- summary_stats %>%
  mutate(subgroup = case_when(
    in_samesex == 1 & exante_old_legal == 1 ~ "samesex_oldlegal",
    in_samesex == 0 & exante_old_legal == 1 ~ "oppositesex_oldlegal",
    in_samesex == 1 & exante_old_legal == 0 ~ "samesex_newlegal",
    in_samesex == 0 & exante_old_legal == 0 ~ "oppositesex_newlegal"
  )) 

#make functions to make charts

make_trend_chart <- function(df, sel_title, facet, facet_titles) {
  chart <- df %>%
  ggplot() +
    geom_line(aes(x = year, y = frac_migrate, linetype = subgroup)) + 
    labs(title = sel_title,
         x = "Year",
         y = "Fraction Migrated",
         linetype = "Subgroup") +
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + #bc factor issues
    scale_linetype_manual(values = c("samesex_oldlegal" = "solid", "oppositesex_oldlegal" = "dotted", "samesex_newlegal" = "longdash", "oppositesex_newlegal" = "dotdash"),
                     labels = c("samesex_oldlegal" = "Same-Sex Individuals in Locally Legalized States", "oppositesex_oldlegal" = "Opposite-Sex Individuals in Locally Legalized States", "samesex_newlegal" = "Same-Sex Individuals in Federally Legalized States", "oppositesex_newlegal" = "Opposite-Sex Individuals in Federally Legalized States")) +
  scale_x_continuous(breaks = 2011:2019) +
  theme_apa() +
  facet_wrap(reformulate(facet), labeller = as_labeller(facet_titles))
  
  return(chart)
}

make_diffs_chart <- function(df, sel_title, group, facet, facet_titles) {
  chart <- df %>%
  select(year, {{ group }}, samesex_diff, oppositesex_diff) %>%
  pivot_longer(cols = c(samesex_diff, oppositesex_diff), names_to = "subgroup", values_to= "diffs") %>%
  ggplot() +
    geom_line(aes(x = year, y = diffs, linetype = subgroup)) + 
    labs(title = sel_title,
         x = "Year",
         y = "Migration Locally - Not/Federally Legalized States", #ambiguous for purposes of from v. to
         linetype = "Subgroup") + 
    geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + 
    scale_linetype_manual(values = c("samesex_diff" = "solid", "oppositesex_diff" = "dashed"),
                     labels = c("samesex_diff" = "Same-Sex Individuals", "oppositesex_diff" = "Opposite-Sex Individuals")) +
  scale_x_continuous(breaks = 2011:2019) +
  theme_apa() +
  facet_wrap(reformulate(facet), labeller = as_labeller(facet_titles))
  return(chart)
}

gc()
###Split by sex
#Post
sex_post_trends_chart <- post_migrant_trends_df %>%
  group_by(year, sex, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  mutate(sex_label = if_else(sex == 1, "male", "female")) %>%
  make_trend_chart(sel_title = "Ex-Post Trends by Gender", facet = "sex_label", facet_titles = c("male" = "Men", "female" = "Women")) #use male/female?

sex_post_diffs_chart <- post_migrant_trends_df %>%
  group_by(year, sex, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  mutate(sex_label = if_else(sex == 1, "male", "female")) %>%
  make_diffs_chart(sel_title = "Ex-Post Diffs by Gender", group = sex_label, facet = "sex_label", facet_titles = c("male" = "Men", "female" = "Women")) #use male/female?
gc()
#Ante
sex_ante_trends_chart <- ante_migrant_trends_df %>%
  group_by(year, sex, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  mutate(sex_label = if_else(sex == 1, "male", "female")) %>%
  make_trend_chart(sel_title = "Ex-Ante Trends by Gender", facet = "sex_label", facet_titles = c("male" = "Men", "female" = "Women")) #use male/female?

sex_ante_diffs_chart <- post_migrant_trends_df %>%
  group_by(year, sex, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  mutate(sex_label = if_else(sex == 1, "male", "female")) %>%
  make_diffs_chart(sel_title = "Ex-Ante Diffs by Gender", group = sex_label, facet = "sex_label", facet_titles = c("male" = "Men", "female" = "Women")) #use male/female?

#takeaways: WOMEN ARE DRIVING EX-POST/EX-ANTE DIFFERENCES YES MAKES SENSE OH LORDY

gc()
###Split by Age
#Post
age_post_trends_chart <- post_migrant_trends_df %>%
  mutate(age_groups = case_when(
    age < 23 ~ "<23",
    age >= 23 & age < 33 ~ "23-32",
    age >= 33 & age < 63 ~ "33-62",
    age >= 63 ~ ">62")) %>% #make these groups better
  group_by(year, age_groups, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Post Trends by Age", facet = "age_groups", facet_titles = c("<23" = "<23", "23-32" = "23-32", "33-62" = "33-62", ">62" = ">62"))

age_post_diffs_chart <- post_migrant_trends_df %>%
  mutate(age_groups = case_when(
    age < 23 ~ "<23",
    age >= 23 & age < 33 ~ "23-32",
    age >= 33 & age < 63 ~ "33-62",
    age >= 63 ~ ">62")) %>% #make these groups better
  group_by(year, age_groups, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Post Diffs by Age", group = age_groups, facet = "age_groups", c("<23" = "<23", "23-32" = "23-32", "33-62" = "33-62", ">62" = ">62"))
gc()
#Ante
age_ante_trends_chart <- ante_migrant_trends_df %>%
  mutate(age_groups = case_when(
    age < 23 ~ "<23",
    age >= 23 & age < 33 ~ "23-32",
    age >= 33 & age < 63 ~ "33-62",
    age >= 63 ~ ">62")) %>% #make these groups better
  group_by(year, age_groups, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Ante Trends by Age", facet = "age_groups", facet_titles = c("<23" = "<23", "23-32" = "23-32", "33-62" = "33-62", ">62" = ">62"))

age_ante_diffs_chart <- post_migrant_trends_df %>%
  mutate(age_groups = case_when(
    age < 23 ~ "<23",
    age >= 23 & age < 33 ~ "23-32",
    age >= 33 & age < 63 ~ "33-62",
    age >= 63 ~ ">62")) %>% #make these groups better
  group_by(year, age_groups, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Ante Diffs by Age", group = age_groups, facet = "age_groups", c("<23" = "<23", "23-32" = "23-32", "33-62" = "33-62", ">62" = ">62"))

#takeaways: minimal meaning, area most of interest is 23-32 (most mobile, period most likely to marry)

###Split by Educ
gc()
#Post
educ_post_trends_chart <- post_migrant_trends_df %>%
  mutate(college = ifelse(educ >= 10, "college", "notcollege")) %>%
  group_by(year, college, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Post Trends by Education", facet = "college", facet_titles = c("college" = ">=4 Years College", "notcollege" = "<4 Years College"))

educ_post_diffs_chart <- post_migrant_trends_df %>%
  mutate(college = ifelse(educ >= 10, "college", "notcollege")) %>%
  group_by(year, college, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Post Diffs by Education", group = college, facet = "college", facet_titles = c("college" = ">=4 Years College", "notcollege" = "<4 Years College"))
gc()
#Ante
educ_ante_trends_chart <- ante_migrant_trends_df %>%
  mutate(college = ifelse(educ >= 10, "college", "notcollege")) %>%
  group_by(year, college, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Ante Trends by Education", facet = "college", facet_titles = c("college" = ">=4 Years College", "notcollege" = "<4 Years College"))

educ_ante_diffs_chart <- post_migrant_trends_df %>%
  mutate(college = ifelse(educ >= 10, "college", "notcollege")) %>%
  group_by(year, college, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Ante Diffs by Education", group = college, facet = "college", facet_titles = c("college" = ">=4 Years College", "notcollege" = "<4 Years College"))

#takeaways: kind of noisy, doesn't seem to follow predicted (post) trend

###Split by Children
gc()
#Post
child_post_trends_chart <- post_migrant_trends_df %>%
  mutate(child = ifelse(has_child ==1, "yes", "no")) %>%
  group_by(year, child, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Post Trends by Presence of Children", facet = "child", facet_titles = c("yes" = "Children Present", "no" = "Children not Present"))

child_post_diffs_chart <- post_migrant_trends_df %>%
  mutate(child = ifelse(has_child ==1, "yes", "no")) %>%
  group_by(year, child, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Post Diffs by Presence of Children", group = child, facet = "child", facet_titles = c("yes" = "Children Present", "no" = "Children not Present"))
gc()
#Ante
child_ante_trends_chart <- ante_migrant_trends_df %>%
  mutate(child = ifelse(has_child ==1, "yes", "no")) %>%
  group_by(year, child, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Ante Trends by Presence of Children", facet = "child", facet_titles = c("yes" = "Children Present", "no" = "Children not Present"))

child_ante_diffs_chart <- post_migrant_trends_df %>%
  mutate(child = ifelse(has_child ==1, "yes", "no")) %>%
  group_by(year, child, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Ante Diffs by Presence of Children", group = child, facet = "child", facet_titles = c("yes" = "Children Present", "no" = "Children not Present"))

#takeaways: noisy; no child post chart kind of interesting/follows predictions (ante looks similar)

###Split by Income
gc()
#Post
inc_post_trends_chart <- post_migrant_trends_df %>%
  group_by(year) %>%
  mutate(mean_income = sum(perwt * inctot, na.rm = T) / sum(perwt, na.rm = T)) %>% #note: applies to whole year population, not separated, watch mean v median, own bootleg weight calculations
  ungroup() %>%
  mutate(income_group = ifelse(inctot < mean_income, "below", "above")) %>%
  group_by(year, income_group, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Post Trends by Income", facet = "income_group", facet_titles = c("above" = "Above Mean", "below" = "Below Mean"))

inc_post_diffs_chart <- post_migrant_trends_df %>%
    group_by(year) %>%
  mutate(mean_income = sum(perwt * inctot, na.rm = T) / sum(perwt, na.rm = T)) %>% #note: applies to whole year population, not separated, watch mean v median, own bootleg weight calculations
  ungroup() %>%
  mutate(income_group = ifelse(inctot < mean_income, "below", "above")) %>%
  group_by(year, income_group, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Post Diffs by Income", group = income_group, facet = "income_group", facet_titles = c("above" = "Above Mean", "below" = "Below Mean"))
gc()
#Ante
inc_ante_trends_chart <- ante_migrant_trends_df %>%
    group_by(year) %>%
  mutate(mean_income = sum(perwt * inctot, na.rm = T) / sum(perwt, na.rm = T)) %>% #note: applies to whole year population, not separated, watch mean v median, own bootleg weight calculations
  ungroup() %>%
  mutate(income_group = ifelse(inctot < mean_income, "below", "above")) %>%
  group_by(year, income_group, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Ante Trends by Income", facet = "income_group", facet_titles = c("above" = "Above Mean", "below" = "Below Mean"))

inc_ante_diffs_chart <- post_migrant_trends_df %>%
    group_by(year) %>%
  mutate(mean_income = sum(perwt * inctot, na.rm = T) / sum(perwt, na.rm = T)) %>% #note: applies to whole year population, not separated, watch mean v median, own bootleg weight calculations
  ungroup() %>%
  mutate(income_group = ifelse(inctot < mean_income, "below", "above")) %>%
  group_by(year, income_group, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Ante Diffs by Income", group = income_group, facet = "income_group", facet_titles = c("above" = "Above Mean", "below" = "Below Mean"))

#takeaways: noisy, (post) kind of follows hypothesis

#Race

gc()
###Split by Region
#Post
gc()
region_post_trends_chart <- post_migrant_trends_df %>%
  group_by(year, expost_region, subgroup) %>% #be careful
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Post Trends by Region", facet = "expost_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast"))

gc()
region_post_diffs_chart <- post_migrant_trends_df %>%
  group_by(year, expost_region, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Post Diffs by Region", group = expost_region, facet = "expost_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast"))

gc()
#Ante
region_ante_trends_chart <- ante_migrant_trends_df %>%
  group_by(year, exante_region, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  make_trend_chart(sel_title = "Ex-Ante Trends by Region", facet = "exante_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast")) #use male/female?

gc()
region_ante_diffs_chart <- post_migrant_trends_df %>%
  group_by(year, exante_region, subgroup) %>%
  summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
  select(-frac_migrate_se) %>%
  ungroup %>%
  pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
  mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
  mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
  make_diffs_chart(sel_title = "Ex-Ante Diffs by Region", group = exante_region, facet = "exante_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast"))

#takeaways: 
#watch missing issues


gc()
###Export (oi map)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/sex_post_trends.png", plot = sex_post_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/sex_post_diffs.png", plot = sex_post_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/sex_ante_trends.png", plot = sex_ante_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/sex_ante_diffs.png", plot = sex_ante_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/age_post_trends.png", plot = age_post_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/age_post_diffs.png", plot = age_post_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/age_ante_trends.png", plot = age_ante_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/age_ante_diffs.png", plot = age_ante_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/educ_post_trends.png", plot = educ_post_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/educ_post_diffs.png", plot = educ_post_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/educ_ante_trends.png", plot = educ_ante_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/educ_ante_diffs.png", plot = educ_ante_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/child_post_trends.png", plot = child_post_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/child_post_diffs.png", plot = child_post_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/child_ante_trends.png", plot = child_ante_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/child_ante_diffs.png", plot = child_ante_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/inc_post_trends.png", plot = inc_post_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/inc_post_diffs.png", plot = inc_post_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/inc_ante_trends.png", plot = inc_ante_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/inc_ante_diffs.png", plot = inc_ante_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_post_trends.png", plot = region_post_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_post_diffs.png", plot = region_post_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_ante_trends.png", plot = region_ante_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_ante_diffs.png", plot = region_ante_diffs_chart)
#more slicing and dicing to do

#more functions?
#separate all collapsing so runs better?
#watch more consistent labeling
#don't do trends just do differences?
#oop make things more efficient so don't have to summarize 4 times (and only twice)
#hmm wonder how much fixed effects would absorbr
#can totally functionalize/map all of this
#for triple diff charts makes sense to add another layer of difference?
#watch rename axes (Not/Federally)
#really wonder how much is motivated by noise/migration levels overall
```

Code
```{r, include = F}
gc()
#code
```

Code
```{r, include = F}
test <- clean_df %>%
  filter(expost_region == "Northeast") %>%
  select(year, expost_state, expost_old_legal) %>%
  distinct() %>%
  filter(expost_old_legal == 0)
#hmm MI coded as Northeast
```