---
title: "F24_build"
output: html_document
date: "2024-12-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages (now many unnecessary)
```{r, include = F}
gc()
library(data.table) #for data loading
library(tidyverse) #for data work
install.packages("janitor")
library(janitor) #for clean_names
install.packages("srvyr")
library(srvyr) #for weighting
library(haven) #for reading in dta

install.packages("kableExtra") #to make more complicated output tables for LATEX
library(kableExtra)
```

Download clean data
```{r, include = F}
gc()
#windows
# clean_df <- read_dta("C:\\Users\\njrich\\Downloads\\clean_dataframe.dta") %>%
#   clean_names()

#mac
clean_df <- read_dta("/Users/njrich/Downloads/clean_dataframe.dta") %>%
  clean_names()

```

Make survey object
```{r, include = F}
gc()

summary_stats <- as_survey(clean_df, weights = perwt) #note: exclude rep_wts so standard errors are inaccurate (file otherwise insanely big- talk someone about it)

```

Summary stats - general population (will need to do a lot of work to functionalize and combine in logical way- think about categories of table types)
```{r, include = F}
gc()
#count those in/not in same sex
count_samesex <- summary_stats %>%
  group_by(year) %>%
  summarize(prop_samesex = survey_mean(in_samesex, na.rm = T)) %>%
  select(-prop_samesex_se)

#need to recreate variables for this
gc()
#count prop in legal same-sex state/not:
# count_in_legal <- summary_stats %>%
#   group_by(year) %>%
#   summarize(prop_in_legal = survey_mean(expost_legal_state, na.rm = T)) %>%
#   select(-prop_in_legal_se) 

###

gc()
#count male/female - think about if need this
count_male_female <- summary_stats %>%
  mutate(sex = ifelse(sex == 9, NA, sex - 1)) %>%
  group_by(year) %>%
  summarize(prop_fem = survey_mean(sex, na.rm = T)) %>%
  select(-prop_fem_se)

gc()
#count prop in post_old_legal state/not (with old_legal definition):
count_in_old_legal <- summary_stats %>%
  group_by(year) %>%
  summarize(prop_in_old_legal = survey_mean(expost_old_legal, na.rm = T)) %>%
  select(-prop_in_old_legal_se)

gc()
#create joint table
joint_overall_table <- count_male_female %>%
  left_join(count_samesex, by = "year") %>%
  left_join(count_in_old_legal, by = "year") %>%
  kable(caption = "Summary Statistics for Overall Population", format = "latex", booktabs = T, digits = 3) 

#export joint table
writeLines(joint_overall_table, "/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/overall_table.tex") #NOTE: THIS IS FOR MAC, WILL NEED TO ADJUST FOR WINDOWS
```

Summary stats - for controls (will need to do a lot of work to functionalize and combine in logical way- think about categories of table types)
```{r, include = F}

gc()
#count male/female among those in same-sex relationships
prop_fem_samesex <- summary_stats %>%
  mutate(sex = ifelse(sex == 9, NA, sex - 1)) %>%
  group_by(year, in_samesex) %>%
  summarize(prop_fem = survey_mean(sex, na.rm = T)) %>%
  select(-prop_fem_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Sex", "Opposite-Sex Sex")) %>%
  pivot_wider(names_from = in_samesex, values_from = prop_fem)

gc()
#fraction with children table
#need to import variables for this

gc()
#mean age by same-sex/opposite-sex weighted, by year
mean_age_samesex <- summary_stats %>%
  group_by(year, in_samesex) %>%
  summarize(mean_age = survey_mean(age, na.rm = T)) %>%
  select(-mean_age_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Age", "Opposite-Sex Age")) %>%
  pivot_wider(names_from = in_samesex, values_from = mean_age)

gc()
#fraction >=4 years college attainment by same-sex/opposite-sex weighted, by year
frac_college_samesex <- summary_stats %>%
  mutate(four_years_college = ifelse(educ >= 10, 1, 0)) %>%
  group_by(year, in_samesex) %>%
  summarize(frac_college = survey_mean(four_years_college, na.rm = T)) %>%
  select(-frac_college_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex College", "Opposite-Sex College")) %>%
  pivot_wider(names_from = in_samesex, values_from = frac_college)

gc()
#fraction white by same-sex/opposite-sex weighted, by year
frac_white_samesex <- summary_stats %>%
  mutate(white = ifelse(race == 1, 1, 0)) %>%
  group_by(year, in_samesex) %>%
  summarize(frac_white = survey_mean(white, na.rm = T)) %>%
  select(-frac_white_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex White", "Opposite-Sex White")) %>%
  pivot_wider(names_from = in_samesex, values_from = frac_white)

gc()
#mean income by same-sex/opposite-sex weighted, by year
mean_income_samesex <- summary_stats %>%
  group_by(year, in_samesex) %>%
  summarize(mean_income = survey_mean(inctot, na.rm = T)) %>%
  select(-mean_income_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Inc", "Opposite-Sex Inc")) %>%
  pivot_wider(names_from = in_samesex, values_from = mean_income)


gc()
#create joint table
joint_control_table <- prop_fem_samesex %>%
  left_join(mean_age_samesex, by = "year") %>%
  left_join(frac_college_samesex, by = "year") %>%
  left_join(frac_white_samesex, by = "year") %>%
  left_join(mean_income_samesex, by = "year") %>%
  setNames(c("Year", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex")) %>% #needs work
  kable(caption = "Summary Statistics for Proposed Controls", format = "latex", booktabs = T, digits = 3) %>%
  add_header_above(c(" " = 1, "Fraction Female" = 2, "Mean Age" = 2, "Fraction At Least 4 Years College" = 2, "Fraction White" = 2, "Mean Income" = 2))

#export joint table
writeLines(joint_control_table, "/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/control_table.tex") #NOTE: THIS IS FOR MAC, WILL NEED TO ADJUST FOR WINDOWS
```

Summary stats - for regression storytelling (will need to do a lot of work to functionalize and combine in logical way- think about categories of table types)
```{r, include = F}
#oop count labeling not super accurate

gc()
#count prop by same_sex in post_old_legal state/not (with old_legal definition):
count_samesex_in_old_legal <- summary_stats %>%
  group_by(year, in_samesex) %>%
  summarize(prop_in_old_legal = survey_mean(expost_old_legal, na.rm = T)) %>%
  select(-prop_in_old_legal_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex in Old Legal", "Opposite-Sex in Old Legal")) %>%
  pivot_wider(names_from = in_samesex, values_from = prop_in_old_legal)

gc()
#count prop migrants by same_sex in post_old_legal state/not (with old_legal definition):
count_samesex_migrants_in_old_legal <- summary_stats %>%
  filter(migrant == 1) %>%
  group_by(year, in_samesex) %>%
  summarize(prop_in_old_legal = survey_mean(expost_old_legal, na.rm = T)) %>%
  select(-prop_in_old_legal_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Migrants in Old Legal", "Opposite-Sex Migrants in Old Legal")) %>%
  pivot_wider(names_from = in_samesex, values_from = prop_in_old_legal)

gc()
#subtracted expost trends table
subtracted_trends_post <- count_samesex_migrants_in_old_legal %>%
  mutate(subtracted_trends_post = `Same-Sex Migrants in Old Legal` - `Opposite-Sex Migrants in Old Legal`) %>%
  select(year, subtracted_trends_post)

gc()
#count prop by same_sex from post_old_legal state/not (with old_legal definition):
count_samesex_from_old_legal <- summary_stats %>%
  group_by(year, in_samesex) %>%
  summarize(prop_from_old_legal = survey_mean(exante_old_legal, na.rm = T)) %>%
  select(-prop_from_old_legal_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex from Old Legal", "Opposite-Sex from Old Legal")) %>%
  pivot_wider(names_from = in_samesex, values_from = prop_from_old_legal)

gc()
#count prop migrants by same_sex in post_old_legal state/not (with old_legal definition):
count_samesex_migrants_from_old_legal <- summary_stats %>%
  filter(migrant == 1) %>%
  group_by(year, in_samesex) %>%
  summarize(prop_from_old_legal = survey_mean(exante_old_legal, na.rm = T)) %>%
  select(-prop_from_old_legal_se) %>%
  mutate(in_samesex = ifelse(in_samesex == 1, "Same-Sex Migrants from Old Legal", "Opposite-Sex Migrants from Old Legal")) %>%
  pivot_wider(names_from = in_samesex, values_from = prop_from_old_legal)

gc()
#subtracted exante trends table
subtracted_trends_ante <- count_samesex_migrants_from_old_legal %>%
  mutate(subtracted_trends_ante = `Same-Sex Migrants from Old Legal` - `Opposite-Sex Migrants from Old Legal`) %>%
  select(year, subtracted_trends_ante)

gc()
#create joint table
joint_differences_table <- count_samesex_in_old_legal %>%
  left_join(count_samesex_migrants_in_old_legal, by = "year") %>%
  left_join(subtracted_trends_post, by = "year") %>%
  left_join(count_samesex_from_old_legal, by = "year") %>%
  left_join(count_samesex_migrants_from_old_legal, by = "year") %>%
  left_join(subtracted_trends_ante, by = "year") %>%
  setNames(c("Year", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Difference", "Same-Sex", "Opposite-Sex", "Same-Sex", "Opposite-Sex", "Difference")) %>% #needs work
  kable(caption = "Summary Statistics for Migration Decisions", format = "latex", booktabs = T, digits = 3) %>%
  add_header_above(c(" " = 1, "Fraction in States Legal Before 2015" = 2, "Migrants in States Legal Before 2015" = 2, " " = 1, "Fraction from States Legal Before 2015" = 2, "Migrants from States Legal Before 2015" = 2, " " = 1)) 

#export joint table
writeLines(joint_differences_table, "/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/differences_table.tex") #NOTE: THIS IS FOR MAC, WILL NEED TO ADJUST FOR WINDOWS
```

Make trends tables from differences tables
```{r, include = F}
gc()
post_migrant_trends <- count_samesex_migrants_in_old_legal %>%
  left_join(subtracted_trends_post, by = "year") %>%
  setNames(c("year", "opp_mig", "same_mig", "subtracted")) %>%
  mutate(year = factor(year)) %>%
  ggplot() +
    geom_point(aes(x = year, y = same_mig), color = "blue") +
    geom_point(aes(x = year, y = opp_mig), color = "red")  +
    labs(title = "Fraction of Migrants to States That Legalized Same-Sex Marriage Before 2015",
         x = "Year",
         y = "Fraction",
         color = "Sexuality") #watch clarifications needed here
post_migrant_trends

#things are lining up but since factor cannot seem to make line, add factor levels?
#hmm incorporate migration decision in here too? use overall pop?
#see old charts more useful more so- make more categories?
```


Export charts
```{r, include = F}
gc()
#code
```

```