/* */
pause off

*install export
ssc install outreg2, replace



///////////////////////// FLOW REGRESSIONS ////////////////////////////

* Define paths to avoid repetition
local output_path "C:\Users\njrich\Desktop\same-sex-migration\outputs\regressions\"

////Models 1 and 2 inputs
clear
use "C:\Users\njrich\Downloads\clean_dataframe.dta"

gen post_treatment = in_samesex * expost_old_legal * post_2015
gen ante_treatment = in_samesex * exante_old_legal * post_2015
gen stay = 1 - migrant

xi i.sex i.race i.educ i.has_child
collapse (mean) _I* age inctot (rawsum) perwt [fweight = perwt], by(year stay tofed_migrant fromfed_migrant tolocal_migrant fromlocal_migrant in_samesex expost_old_legal exante_old_legal expost_state exante_state post_2015 post_treatment ante_treatment)

///Model 1
* Function for running model 1 and saving results
macro define run_model1(model_type, treatment_var, state_var, outcome, col_name, append_replace) {
    reg `outcome' `treatment_var' i.`state_var'##i.year `state_var'##in_samesex i.year##in_samesex [w=perwt], vce(cluster `state_var' year)
    if "`append_replace'" == "replace" {
	outreg2 using "`output_path'flow_`model_type'_model.tex", replace tex(fragment) ctitle(`col_name') label dec(3) se keep(`treatment_var') addnote("See below.")
	}
	else {
	outreg2 using "`output_path'flow_`model_type'_model.tex", append tex(fragment) ctitle(`col_name') label dec(3) se keep(`treatment_var') addnote("See below.")
	}
}

//Post
*from fed (of interest)
run_model1(model_type = "expost", treatment_var = post_treatment, state_var = expost_state, outcome = fromfed_migrant, col_name = "From Fed/Not", append_replace = "replace")
*from local
run_model1(model_type = "expost", treatment_var = post_treatment, state_var = expost_state, outcome = fromlocal_migrant, col_name = "From Local", append_replace = "append")
*from stay
run_model1(model_type = "expost", treatment_var = post_treatment, state_var = expost_state, outcome = stay, col_name = "From Same State", append_replace = "append")
//Ante
*to fed (of interest)
run_model1(model_type = "exante", treatment_var = ante_treatment, state_var = exante_state, outcome = tofed_migrant, col_name = "To Fed/Not", append_replace = "replace")
*to local
run_model1(model_type = "exante", treatment_var = ante_treatment, state_var = exante_state, outcome = tolocal_migrant, col_name = "To Local", append_replace = "append")
*to stay
run_model1(model_type = "exante", treatment_var = ante_treatment, state_var = exante_state, outcome = stay, col_name = "To Same State", append_replace = "append")




*UM WHERE DID 2011 GO? DROPPED?
*why do my P values change so m
*doing things the ugly way time
*WATCH WEIGHTS
*check work for errors