rename(paststate = {{ variable }}, exante_state = state, exante_date_legalization = date_legalization, exante_legal_state = legal_state, exante_old_legal = old_legal) #hmm does this variable relabeling make sense need {{ variable }}?
}
return(df)
}
#run state label and ex-ante ex-post labeling functions
add_state_labels <- function(df, variable, label) {
df <- df %>%
rename(variable = {{ variable }})
df <- state_labels(df, variable, label)
df <- add_exantepost(df, variable, label)
gc()
return(df)
}
#filter + add useful past_state variable
df_samesex <- df_samesex %>%
filter(statefip < 60) %>% #restrict to within 50 states
filter(migplac1 < 60) %>% #restrict to within 50 states
mutate(past_state = ifelse(migplac1 == 0, statefip, migplac1))
#RUN TWO MAJOR FUNCTIONS
#ex-post (ie look at legal status of state moved to)
df_samesex <- add_state_labels(df_samesex, statefip, "expost")
#ex-ante (ie look at legal status of state moved from)
df_samesex <- add_state_labels(df_samesex, past_state, "exante")
#add output labels incl. for heterogeneity tests
df_samesex <-df_samesex %>%
mutate(migrant = ifelse(migplac1 == 0, 0, 1)) %>% #think if can use logic statement/past_state var
mutate(localtofed_migrant = ifelse(migrant == 0, 0, ifelse(exante_old_legal == 0, 0, ifelse(expost_old_legal == 0, 1, 0)))) %>% #note: indpt. expost/exante analysis
mutate(localtolocal_migrant = ifelse(migrant == 0, 0, ifelse(exante_old_legal == 0, 0, ifelse(expost_old_legal == 1, 1, 0)))) %>%
mutate(fedtofed_migrant = ifelse(migrant == 0, 0, ifelse(exante_old_legal == 1, 0, ifelse(expost_old_legal == 0, 1, 0)))) %>%
mutate(fedtolocal_migrant = ifelse(migrant == 0, 0, ifelse(exante_old_legal == 1, 0, ifelse(expost_old_legal == 1, 1, 0)))) %>%
mutate(tofed_migrant = ifelse(migrant == 0, 0, ifelse(expost_old_legal == 0, 1, 0))) %>%
mutate(tolocal_migrant = ifelse(migrant == 0, 0, ifelse(expost_old_legal == 0, 0, 1))) %>% #for purposes of ex-ante regression breakdown, this is most useful
mutate(fromfed_migrant = ifelse(migrant == 0, 0, ifelse(exante_old_legal == 0, 1, 0))) %>%
mutate(fromlocal_migrant = ifelse(migrant == 0, 0, ifelse(exante_old_legal == 0, 0, 1))) #for purposes of ex-post regression breakdown, this is most useful
#add person-level input labels
df_samesex <-df_samesex %>%
mutate(sex_sp = ifelse(sex_sp == 9, NA, sex_sp)) %>%
mutate(in_samesex = ifelse(sex_sp == sex, 1, 0)) %>% #watch techdef here/coding issues
mutate(in_oppositesex = ifelse((sex_sp != sex) & !is.na(sex_sp), 1, 0)) %>% #watch techdef here
mutate(post_2015 = ifelse(year >= 2015, 1, 0)) %>%
mutate(has_child = ifelse(nchild > 0, 1, 0)) #think: want to include if partner has child?
return(df_samesex)
#collapse for readability/organization above?
}
#summary_stats <- add_context(summary_stats)
working_df <- add_context(working_df)
#check ex-post ex-ante labeling- test by unique-ing- seems to work
#test <- working_df %>%
#  distinct(exante_state, expost_state)
gc()
technical_cleaning <- function (data) {
gc()
data <- data %>%
mutate(expost_state = factor(expost_state)) %>%
mutate(exante_state = factor(exante_state)) %>%
filter(sex != 9) %>%
filter(age != 999) %>%
mutate(race = factor(race))
gc()
data <- data %>%
filter(educ != 99) %>%
mutate(educ = factor(educ)) %>%
filter(empstat != 9) %>%
mutate(empstat = factor(empstat)) %>%
mutate(occ = factor(occ)) %>%
mutate(ind = factor (ind)) %>%
filter(inctot != 9999998)
gc()
data <- data %>%
mutate(inctot = ifelse(inctot == 9999999, NA, inctot)) %>%
filter(migplac1 <= 57) %>%
mutate(migplac1 = factor(migplac1)) %>% #ensure migrants have state identified
filter(qsex != 4) %>% #get rid of those with imputed sex- watch partner's sex here too
filter(qrace != 3) %>% #get rid of missing race
mutate(offpov = factor(offpov)) %>%
mutate(sex_sp = ifelse(sex_sp == 9, NA, sex_sp)) %>% #relabel no have partner, watch placement in code
filter(!is.na(sex_sp)) %>% #to restrict to only those in relationships (argue more model cleaning than technical cleaning oops)
mutate(sex_sp = factor(sex_sp))
gc()
data <- data %>%
filter(bpl <= 57) #exclude people born outside of the US/in US territories
return(data)
}
working_df <- technical_cleaning(working_df)
gc()
technical_cleaning <- function (data) {
gc()
data <- data %>%
mutate(expost_state = factor(expost_state)) %>%
mutate(exante_state = factor(exante_state)) %>%
filter(sex != 9) %>%
filter(age != 999) %>%
mutate(race = factor(race))
gc()
data <- data %>%
filter(educ != 99) %>%
mutate(educ = factor(educ)) %>%
filter(empstat != 9) %>%
mutate(empstat = factor(empstat)) %>%
mutate(occ = factor(occ)) %>%
mutate(ind = factor (ind)) %>%
filter(inctot != 9999998)
gc()
data <- data %>%
mutate(inctot = ifelse(inctot == 9999999, NA, inctot)) %>%
filter(migplac1 <= 57) %>%
mutate(migplac1 = factor(migplac1)) %>% #ensure migrants have state identified
filter(qsex != 4) %>% #get rid of those with imputed sex- watch partner's sex here too
filter(qrace != 3) %>% #get rid of missing race
mutate(offpov = factor(offpov)) %>%
mutate(sex_sp = ifelse(sex_sp == 9, NA, sex_sp)) %>% #relabel no have partner, watch placement in code
filter(!is.na(sex_sp)) %>% #to restrict to only those in relationships (argue more model cleaning than technical cleaning oops)
mutate(sex_sp = factor(sex_sp))
gc()
data <- data %>%
filter(bpl <= 57) #exclude people born outside of the US/in US territories
return(data)
}
working_df <- technical_cleaning(working_df)
gc()
rm(W25_pull1)
rm(add_context)
gc()
gc()
technical_cleaning <- function (data) {
gc()
data <- data %>%
mutate(expost_state = factor(expost_state)) %>%
mutate(exante_state = factor(exante_state)) %>%
filter(sex != 9) %>%
filter(age != 999) %>%
mutate(race = factor(race))
gc()
data <- data %>%
filter(educ != 99) %>%
mutate(educ = factor(educ)) %>%
filter(empstat != 9) %>%
mutate(empstat = factor(empstat)) %>%
mutate(occ = factor(occ)) %>%
mutate(ind = factor (ind)) %>%
filter(inctot != 9999998)
gc()
data <- data %>%
mutate(inctot = ifelse(inctot == 9999999, NA, inctot)) %>%
filter(migplac1 <= 57) %>%
mutate(migplac1 = factor(migplac1)) %>% #ensure migrants have state identified
filter(qsex != 4) %>% #get rid of those with imputed sex- watch partner's sex here too
filter(qrace != 3) %>% #get rid of missing race
mutate(offpov = factor(offpov)) %>%
mutate(sex_sp = ifelse(sex_sp == 9, NA, sex_sp)) %>% #relabel no have partner, watch placement in code
filter(!is.na(sex_sp)) %>% #to restrict to only those in relationships (argue more model cleaning than technical cleaning oops)
mutate(sex_sp = factor(sex_sp))
gc()
data <- data %>%
filter(bpl <= 57) #exclude people born outside of the US/in US territories
return(data)
}
working_df <- technical_cleaning(working_df)
#oop works just very slow
gc()
selected_data <- working_df %>%
select(migrant, localtolocal_migrant, localtofed_migrant, fedtofed_migrant, fedtolocal_migrant, in_samesex, expost_old_legal, exante_old_legal, post_2015, sex, age, race, educ, occ, ind, bpl, has_child, inctot, perwt, year, expost_state, exante_state, tofed_migrant, fromfed_migrant, tolocal_migrant, fromlocal_migrant)
rm(W25_pull1, add_context, technical_cleaning)
#Export for STATA analysis (can use other purposes low key too)
write_dta(selected_data, "C:\\Users\\njrich\\Downloads\\clean_dataframe.dta")
gc()
#more than one way to generate variables of interest welp (like could do stata way)
gc()
selected_data <- working_df %>%
select(migrant, localtolocal_migrant, localtofed_migrant, fedtofed_migrant, fedtolocal_migrant, in_samesex, expost_old_legal, exante_old_legal, post_2015, sex, age, race, educ, occ, ind, bpl, has_child, inctot, perwt, year, expost_state, exante_state, tofed_migrant, fromfed_migrant, tolocal_migrant, fromlocal_migrant)
#rm(W25_pull1, add_context, technical_cleaning)
#Export for STATA analysis (can use other purposes low key too)
write_dta(selected_data, "C:\\Users\\njrich\\Downloads\\clean_dataframe.dta")
gc()
#more than one way to generate variables of interest welp (like could do stata way)
knitr::opts_chunk$set(echo = TRUE)
gc()
library(data.table) #for data loading
library(tidyverse) #for data work
install.packages("janitor")
library(janitor) #for clean_names
install.packages("srvyr")
library(srvyr) #for weighting
library(haven) #for reading in dta
install.packages("kableExtra") #to make more complicated output tables for LATEX
library(kableExtra)
install.packages("jtools") #for ggplot visualization
library(jtools)
gc()
#windows
clean_df <- read_dta("C:\\Users\\njrich\\Downloads\\clean_dataframe.dta") %>%
clean_names()
#mac
# clean_df <- read_dta("/Users/njrich/Downloads/clean_dataframe.dta") %>%
#   clean_names()
gc()
summary_stats <- as_survey(clean_df, weights = perwt) #note: exclude rep_wts so standard errors are inaccurate (file otherwise insanely big- talk someone about it)
gc()
#make dfs
post_migrant_trends_df <- summary_stats %>%
mutate(subgroup = case_when(
in_samesex == 1 & expost_old_legal == 1 ~ "samesex_oldlegal",
in_samesex == 0 & expost_old_legal == 1 ~ "oppositesex_oldlegal",
in_samesex == 1 & expost_old_legal == 0 ~ "samesex_newlegal",
in_samesex == 0 & expost_old_legal == 0 ~ "oppositesex_newlegal"
))
ante_migrant_trends_df <- summary_stats %>%
mutate(subgroup = case_when(
in_samesex == 1 & exante_old_legal == 1 ~ "samesex_oldlegal",
in_samesex == 0 & exante_old_legal == 1 ~ "oppositesex_oldlegal",
in_samesex == 1 & exante_old_legal == 0 ~ "samesex_newlegal",
in_samesex == 0 & exante_old_legal == 0 ~ "oppositesex_newlegal"
))
#make functions to make charts
make_trend_chart <- function(df, sel_title, facet, facet_titles) {
chart <- df %>%
ggplot() +
geom_line(aes(x = year, y = frac_migrate, linetype = subgroup)) +
labs(title = sel_title,
x = "Year",
y = "Fraction Migrated",
linetype = "Subgroup") +
geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + #bc factor issues
scale_linetype_manual(values = c("samesex_oldlegal" = "solid", "oppositesex_oldlegal" = "dotted", "samesex_newlegal" = "longdash", "oppositesex_newlegal" = "dotdash"),
labels = c("samesex_oldlegal" = "Same-Sex Individuals in Locally Legalized States", "oppositesex_oldlegal" = "Opposite-Sex Individuals in Locally Legalized States", "samesex_newlegal" = "Same-Sex Individuals in Federally Legalized States", "oppositesex_newlegal" = "Opposite-Sex Individuals in Federally Legalized States")) +
scale_x_continuous(breaks = 2011:2019) +
theme_apa() +
facet_wrap(reformulate(facet), labeller = as_labeller(facet_titles))
return(chart)
}
make_diffs_chart <- function(df, sel_title, group, facet, facet_titles) {
chart <- df %>%
select(year, {{ group }}, samesex_diff, oppositesex_diff) %>%
pivot_longer(cols = c(samesex_diff, oppositesex_diff), names_to = "subgroup", values_to= "diffs") %>%
ggplot() +
geom_line(aes(x = year, y = diffs, linetype = subgroup)) +
labs(title = sel_title,
x = "Year",
y = "Migration Locally - Not/Federally Legalized States", #ambiguous for purposes of from v. to
linetype = "Subgroup") +
geom_vline(xintercept = 2015, color = "black", linetype = "dashed") +
scale_linetype_manual(values = c("samesex_diff" = "solid", "oppositesex_diff" = "dashed"),
labels = c("samesex_diff" = "Same-Sex Individuals", "oppositesex_diff" = "Opposite-Sex Individuals")) +
scale_x_continuous(breaks = 2011:2019) +
theme_apa() +
facet_wrap(reformulate(facet), labeller = as_labeller(facet_titles))
return(chart)
}
region_post_trends_chart <- post_migrant_trends_df %>%
group_by(year, expost_region, subgroup) %>% #be careful
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
make_trend_chart(sel_title = "Ex-Post Trends by Region", facet = "expost_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast"))
region_post_diffs_chart <- post_migrant_trends_df %>%
group_by(year, expost_region, subgroup) %>%
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
make_diffs_chart(sel_title = "Ex-Post Diffs by Region", group = expost_region, facet = "expost_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast"))
#Ante
region_ante_trends_chart <- ante_migrant_trends_df %>%
group_by(year, exante_region, subgroup) %>%
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
make_trend_chart(sel_title = "Ex-Ante Trends by Region", facet = "exante_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast")) #use male/female?
region_ante_diffs_chart <- post_migrant_trends_df %>%
group_by(year, exante_region, subgroup) %>%
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
make_diffs_chart(sel_title = "Ex-Ante Diffs by Region", group = exante_region, facet = "exante_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast")) #use male/female?
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_post_trends.png", plot = region_post_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_post_diffs.png", plot = region_post_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_ante_trends.png", plot = region_ante_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_ante_diffs.png", plot = region_ante_diffs_chart)
region_post_diffs_chart
region_post_trends_chart <- post_migrant_trends_df %>%
group_by(year, expost_region, subgroup) %>% #be careful
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
knitr::opts_chunk$set(echo = TRUE)
gc()
library(data.table) #for data loading
library(tidyverse) #for data work
install.packages("janitor")
library(janitor) #for clean_names
install.packages("srvyr")
library(srvyr) #for weighting
library(haven) #for reading in dta
install.packages("kableExtra") #to make more complicated output tables for LATEX
library(kableExtra)
install.packages("jtools") #for ggplot visualization
library(jtools)
gc()
#windows
clean_df <- read_dta("C:\\Users\\njrich\\Downloads\\clean_dataframe.dta") %>%
clean_names()
install.packages("jtools")
install.packages("kableExtra")
#mac
# clean_df <- read_dta("/Users/njrich/Downloads/clean_dataframe.dta") %>%
#   clean_names()
gc()
summary_stats <- as_survey(clean_df, weights = perwt) #note: exclude rep_wts so standard errors are inaccurate (file otherwise insanely big- talk someone about it)
install.packages("kableExtra")
gc()
#make dfs
post_migrant_trends_df <- summary_stats %>%
mutate(subgroup = case_when(
in_samesex == 1 & expost_old_legal == 1 ~ "samesex_oldlegal",
in_samesex == 0 & expost_old_legal == 1 ~ "oppositesex_oldlegal",
in_samesex == 1 & expost_old_legal == 0 ~ "samesex_newlegal",
in_samesex == 0 & expost_old_legal == 0 ~ "oppositesex_newlegal"
))
ante_migrant_trends_df <- summary_stats %>%
mutate(subgroup = case_when(
in_samesex == 1 & exante_old_legal == 1 ~ "samesex_oldlegal",
in_samesex == 0 & exante_old_legal == 1 ~ "oppositesex_oldlegal",
in_samesex == 1 & exante_old_legal == 0 ~ "samesex_newlegal",
in_samesex == 0 & exante_old_legal == 0 ~ "oppositesex_newlegal"
))
#make functions to make charts
make_trend_chart <- function(df, sel_title, facet, facet_titles) {
chart <- df %>%
ggplot() +
geom_line(aes(x = year, y = frac_migrate, linetype = subgroup)) +
labs(title = sel_title,
x = "Year",
y = "Fraction Migrated",
linetype = "Subgroup") +
geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + #bc factor issues
scale_linetype_manual(values = c("samesex_oldlegal" = "solid", "oppositesex_oldlegal" = "dotted", "samesex_newlegal" = "longdash", "oppositesex_newlegal" = "dotdash"),
labels = c("samesex_oldlegal" = "Same-Sex Individuals in Locally Legalized States", "oppositesex_oldlegal" = "Opposite-Sex Individuals in Locally Legalized States", "samesex_newlegal" = "Same-Sex Individuals in Federally Legalized States", "oppositesex_newlegal" = "Opposite-Sex Individuals in Federally Legalized States")) +
scale_x_continuous(breaks = 2011:2019) +
theme_apa() +
facet_wrap(reformulate(facet), labeller = as_labeller(facet_titles))
return(chart)
}
make_diffs_chart <- function(df, sel_title, group, facet, facet_titles) {
chart <- df %>%
select(year, {{ group }}, samesex_diff, oppositesex_diff) %>%
pivot_longer(cols = c(samesex_diff, oppositesex_diff), names_to = "subgroup", values_to= "diffs") %>%
ggplot() +
geom_line(aes(x = year, y = diffs, linetype = subgroup)) +
labs(title = sel_title,
x = "Year",
y = "Migration Locally - Not/Federally Legalized States", #ambiguous for purposes of from v. to
linetype = "Subgroup") +
geom_vline(xintercept = 2015, color = "black", linetype = "dashed") +
scale_linetype_manual(values = c("samesex_diff" = "solid", "oppositesex_diff" = "dashed"),
labels = c("samesex_diff" = "Same-Sex Individuals", "oppositesex_diff" = "Opposite-Sex Individuals")) +
scale_x_continuous(breaks = 2011:2019) +
theme_apa() +
facet_wrap(reformulate(facet), labeller = as_labeller(facet_titles))
return(chart)
}
gc()
region_post_trends_chart <- post_migrant_trends_df %>%
group_by(year, expost_region, subgroup) %>% #be careful
summarize(frac_migrate = survey_mean(migrant, na.rm = T))
View(region_post_trends_chart)
knitr::opts_chunk$set(echo = TRUE)
gc()
library(data.table) #for data loading
library(tidyverse) #for data work
install.packages("janitor")
library(janitor) #for clean_names
install.packages("srvyr")
library(srvyr) #for weighting
library(haven) #for reading in dta
install.packages("kableExtra") #to make more complicated output tables for LATEX
library(kableExtra)
install.packages("jtools") #for ggplot visualization
library(jtools)
install.packages("jtools")
install.packages("kableExtra")
gc()
#windows
clean_df <- read_dta("C:\\Users\\njrich\\Downloads\\clean_dataframe.dta") %>%
clean_names() %>%
mutate(across(where(is.labelled), ~ as.character(as_factor(.)))) #hopefully this doesn't break things
#mac
# clean_df <- read_dta("/Users/njrich/Downloads/clean_dataframe.dta") %>%
#   clean_names()
gc()
summary_stats <- as_survey(clean_df, weights = perwt) #note: exclude rep_wts so standard errors are inaccurate (file otherwise insanely big- talk someone about it)
gc()
#make dfs
post_migrant_trends_df <- summary_stats %>%
mutate(subgroup = case_when(
in_samesex == 1 & expost_old_legal == 1 ~ "samesex_oldlegal",
in_samesex == 0 & expost_old_legal == 1 ~ "oppositesex_oldlegal",
in_samesex == 1 & expost_old_legal == 0 ~ "samesex_newlegal",
in_samesex == 0 & expost_old_legal == 0 ~ "oppositesex_newlegal"
))
ante_migrant_trends_df <- summary_stats %>%
mutate(subgroup = case_when(
in_samesex == 1 & exante_old_legal == 1 ~ "samesex_oldlegal",
in_samesex == 0 & exante_old_legal == 1 ~ "oppositesex_oldlegal",
in_samesex == 1 & exante_old_legal == 0 ~ "samesex_newlegal",
in_samesex == 0 & exante_old_legal == 0 ~ "oppositesex_newlegal"
))
#make functions to make charts
make_trend_chart <- function(df, sel_title, facet, facet_titles) {
chart <- df %>%
ggplot() +
geom_line(aes(x = year, y = frac_migrate, linetype = subgroup)) +
labs(title = sel_title,
x = "Year",
y = "Fraction Migrated",
linetype = "Subgroup") +
geom_vline(xintercept = 2015, color = "black", linetype = "dashed") + #bc factor issues
scale_linetype_manual(values = c("samesex_oldlegal" = "solid", "oppositesex_oldlegal" = "dotted", "samesex_newlegal" = "longdash", "oppositesex_newlegal" = "dotdash"),
labels = c("samesex_oldlegal" = "Same-Sex Individuals in Locally Legalized States", "oppositesex_oldlegal" = "Opposite-Sex Individuals in Locally Legalized States", "samesex_newlegal" = "Same-Sex Individuals in Federally Legalized States", "oppositesex_newlegal" = "Opposite-Sex Individuals in Federally Legalized States")) +
scale_x_continuous(breaks = 2011:2019) +
theme_apa() +
facet_wrap(reformulate(facet), labeller = as_labeller(facet_titles))
return(chart)
}
make_diffs_chart <- function(df, sel_title, group, facet, facet_titles) {
chart <- df %>%
select(year, {{ group }}, samesex_diff, oppositesex_diff) %>%
pivot_longer(cols = c(samesex_diff, oppositesex_diff), names_to = "subgroup", values_to= "diffs") %>%
ggplot() +
geom_line(aes(x = year, y = diffs, linetype = subgroup)) +
labs(title = sel_title,
x = "Year",
y = "Migration Locally - Not/Federally Legalized States", #ambiguous for purposes of from v. to
linetype = "Subgroup") +
geom_vline(xintercept = 2015, color = "black", linetype = "dashed") +
scale_linetype_manual(values = c("samesex_diff" = "solid", "oppositesex_diff" = "dashed"),
labels = c("samesex_diff" = "Same-Sex Individuals", "oppositesex_diff" = "Opposite-Sex Individuals")) +
scale_x_continuous(breaks = 2011:2019) +
theme_apa() +
facet_wrap(reformulate(facet), labeller = as_labeller(facet_titles))
return(chart)
}
gc()
region_post_trends_chart <- post_migrant_trends_df %>%
group_by(year, expost_region, subgroup) %>% #be careful
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
make_trend_chart(sel_title = "Ex-Post Trends by Region", facet = "expost_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast"))
region_post_trends_chart
gc()
region_post_diffs_chart <- post_migrant_trends_df %>%
group_by(year, expost_region, subgroup) %>%
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
make_diffs_chart(sel_title = "Ex-Post Diffs by Region", group = expost_region, facet = "expost_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast"))
gc()
#Ante
region_ante_trends_chart <- ante_migrant_trends_df %>%
group_by(year, exante_region, subgroup) %>%
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
make_trend_chart(sel_title = "Ex-Ante Trends by Region", facet = "exante_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast")) #use male/female?
gc()
region_ante_diffs_chart <- post_migrant_trends_df %>%
group_by(year, exante_region, subgroup) %>%
summarize(frac_migrate = survey_mean(migrant, na.rm = T)) %>%
select(-frac_migrate_se) %>%
ungroup %>%
pivot_wider(names_from = subgroup, values_from = frac_migrate) %>%
mutate(samesex_diff = samesex_oldlegal - samesex_newlegal) %>%
mutate(oppositesex_diff = oppositesex_oldlegal - oppositesex_newlegal) %>%
make_diffs_chart(sel_title = "Ex-Ante Diffs by Region", group = exante_region, facet = "exante_region", facet_titles = c("Midwest" = "Midwest", "West" = "West", "South" = "South", "Northeast" = "Northeast"))
colnames(clean_df)
test <- clean_df %>%
filter(expost_region == "Northeast") %>%
select(year, expost_state, expost_old_legal) %>%
distinct()
View(test)
test <- clean_df %>%
filter(expost_region == "Northeast") %>%
select(year, expost_state, expost_old_legal) %>%
distinct() %>%
filter(expost_old_legal == 0)
View(test)
knitr::opts_chunk$set(echo = TRUE)
gc()
library(tidyverse) #for data work
install.packages("janitor")
library(janitor) #for clean_names
install.packages("srvyr")
library(srvyr) #for weighting
library(haven) #for stata data export/import
install.packages("srvyr")
install.packages("janitor")
pop_support <- read_dta("C:\\Users\\njrich\\Downloads\\anes_timeseries_2016.dta") %>%
clean_names() %>%
select(v160102, v163001a, v162103) %>%
rename(sweight = v160102, fipstate = v163001a, lgbt_support = v162103)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_post_trends.png", plot = region_post_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_post_diffs.png", plot = region_post_diffs_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_ante_trends.png", plot = region_ante_trends_chart)
ggsave("/Users/njrich/Desktop/same-sex-migration/outputs/summary_stats/region_ante_diffs.png", plot = region_ante_diffs_chart)
