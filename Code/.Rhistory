mutate(date_legalization = case_when(
state_name == "GA" ~ 2015,
state_name == "HI" ~ 2013,
state_name == "ID" ~ 2014,
state_name == "IL" ~ 2013,
state_name == "IN" ~ 2014,
state_name == "IA" ~ 2009,
state_name == "KS" ~ 2014,
state_name == "KY" ~ 2015,
state_name == "LA" ~ 2015,
state_name == "ME" ~ 2012,
date_legalization == TRUE ~ date_legalization))
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = case_when(
state_name == "MD" ~ 2012,
state_name == "MA" ~ 2003,
state_name == "MI" ~ 2015,
state_name == "MN" ~ 2013,
state_name == "MS" ~ 2015,
state_name == "MO" ~ 2015,
state_name == "MT" ~ 2014,
state_name == "NE" ~ 2015,
state_name == "NV" ~ 2014,
state_name == "NH" ~ 2009,
date_legalization == TRUE ~ date_legalization))
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = case_when(
state_name == "NJ" ~ 2013,
state_name == "NM" ~ 2013,
state_name == "NY" ~ 2011,
state_name == "NC" ~ 2014,
state_name == "ND" ~ 2015,
state_name == "OH" ~ 2015,
state_name == "OK" ~ 2014,
state_name == "OR" ~ 2014,
state_name == "PA" ~ 2014,
state_name == "RI" ~ 2013,
date_legalization == TRUE ~ date_legalization))
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = case_when(
state_name == "SC" ~ 2014,
state_name == "SD" ~ 2015,
state_name == "TN" ~ 2015,
state_name == "TX" ~ 2015,
state_name == "UT" ~ 2014,
state_name == "VT" ~ 2009,
state_name == "VA" ~ 2014,
state_name == "WA" ~ 2012,
state_name == "WV" ~ 2014,
state_name == "WI" ~ 2014,
state_name == "WY" ~ 2014,
state_name == "PR" ~ 2015, #from googling
state_name == "OMI" ~ 2015, #from guessing
date_legalization == TRUE ~ date_legalization
))
#make time_since variable
gc()
df_samesex <- df_samesex %>%
mutate(time_since_legalization = if_else(YEAR - date_legalization < 0, NA, YEAR - date_legalization)) #check if this makes sense
#save output of this somewhere for ease of use?
unique(df_samesex$state_name)
df_samesex <- df_samesex %>% select(-state_name)
gc()
df_samesex <- df_samesex %>%k
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
STATEFIP == 1 ~ "AL",
STATEFIP == 2 ~ "AK",
STATEFIP == 4 ~ "AZ",
STATEFIP == 5 ~ "AR",
STATEFIP == 6 ~ "CA",
STATEFIP == 8 ~ "CO",
STATEFIP == 9 ~ "CT",
STATEFIP == 10 ~ "DE",
TRUE ~ state_name))
gc()
df_samesex <- df_samesex %>%
mutate(state_name = NA) %>% #ok this seems to work
mutate(state_name = case_when(
STATEFIP == 1 ~ "AL",
STATEFIP == 2 ~ "AK",
STATEFIP == 4 ~ "AZ",
STATEFIP == 5 ~ "AR",
STATEFIP == 6 ~ "CA",
STATEFIP == 8 ~ "CO",
STATEFIP == 9 ~ "CT",
STATEFIP == 10 ~ "DE",
state_name == TRUE ~ state_name))
gc()
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
STATEFIP == 11 ~ "DC",
STATEFIP == 12 ~ "FL",
STATEFIP == 13 ~ "GA",
STATEFIP == 15 ~ "HI",
STATEFIP == 16 ~ "ID",
STATEFIP == 17 ~ "IL",
STATEFIP == 18 ~ "IN",
STATEFIP == 19 ~ "IA",
STATEFIP == 20 ~ "KS",
state_name == TRUE ~ state_name))
unique(df_samesex$state_name)
gc()
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
STATEFIP == 41 ~ "OR",
STATEFIP == 42 ~ "PA",
STATEFIP == 44 ~ "RI",
STATEFIP == 45 ~ "SC",
STATEFIP == 46 ~ "SD",
STATEFIP == 47 ~ "TN",
STATEFIP == 48 ~ "TX",
STATEFIP == 49 ~ "UT",
STATEFIP == 50 ~ "VT",
STATEFIP == 51 ~ "VA",
STATEFIP == 53 ~ "WA",
STATEFIP == 54 ~ "WV",
STATEFIP == 55 ~ "WI",
STATEFIP == 56 ~ "WY",
STATEFIP == 72 ~ "PR",
STATEFIP == 97 ~ "OMI", #Overseas Military Installations
STATEFIP == 99 ~ NA, #redundant now
state_name == TRUE ~ state_name
))
unique(df_samesex$state_name)
gc()
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
STATEFIP == 31 ~ "NE",
STATEFIP == 32 ~ "NV",
STATEFIP == 33 ~ "NH",
STATEFIP == 34 ~ "NJ",
STATEFIP == 35 ~ "NM",
STATEFIP == 36 ~ "NY",
STATEFIP == 37 ~ "NC",
STATEFIP == 38 ~ "ND",
STATEFIP == 39 ~ "OH",
STATEFIP == 40 ~ "OK",
state_name == TRUE ~ state_name))
unique(df_samesex$state_name)
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
STATEFIP == 31 ~ "NE",
STATEFIP == 32 ~ "NV",
STATEFIP == 33 ~ "NH",
STATEFIP == 34 ~ "NJ",
STATEFIP == 35 ~ "NM",
STATEFIP == 36 ~ "NY",
STATEFIP == 37 ~ "NC",
STATEFIP == 38 ~ "ND",
STATEFIP == 39 ~ "OH",
STATEFIP == 40 ~ "OK",
state_name == TRUE ~ state_name))
unique(df_samesex$state_name)
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
STATEFIP == 41 ~ "OR",
STATEFIP == 42 ~ "PA",
STATEFIP == 44 ~ "RI",
STATEFIP == 45 ~ "SC",
STATEFIP == 46 ~ "SD",
STATEFIP == 47 ~ "TN",
STATEFIP == 48 ~ "TX",
STATEFIP == 49 ~ "UT",
STATEFIP == 50 ~ "VT",
STATEFIP == 51 ~ "VA",
STATEFIP == 53 ~ "WA",
STATEFIP == 54 ~ "WV",
STATEFIP == 55 ~ "WI",
STATEFIP == 56 ~ "WY",
STATEFIP == 72 ~ "PR",
STATEFIP == 97 ~ "OMI", #Overseas Military Installations
STATEFIP == 99 ~ NA, #redundant now
state_name == TRUE ~ state_name
))
unique(df_samesex$state_name)
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
STATEFIP == 21 ~ "KY",
STATEFIP == 22 ~ "LA",
STATEFIP == 23 ~ "MI",
STATEFIP == 24 ~ "MD",
STATEFIP == 25 ~ "MA",
STATEFIP == 26 ~ "ME",
STATEFIP == 27 ~ "MN",
STATEFIP == 28 ~ "MS",
STATEFIP == 29 ~ "MO",
STATEFIP == 30 ~ "MT",
state_name == TRUE ~ state_name))
unique(df_samesex$state_name)
?%in%
df_samesex <- df_samesex %>%
mutate(state_name = NA) %>% #ok this seems to work
mutate(state_name = case_when(
STATEFIP == 1 ~ "AL",
STATEFIP == 2 ~ "AK",
STATEFIP == 4 ~ "AZ",
STATEFIP == 5 ~ "AR",
STATEFIP == 6 ~ "CA",
STATEFIP == 8 ~ "CO",
STATEFIP == 9 ~ "CT",
STATEFIP == 10 ~ "DE",
!1:10 %in% STATEFIP ~ state_name))
gc()
df_samesex <- df_samesex %>%
mutate(state_name = NA) %>% #ok this seems to work
mutate(state_name = case_when(
STATEFIP == 1 ~ "AL",
STATEFIP == 2 ~ "AK",
STATEFIP == 4 ~ "AZ",
STATEFIP == 5 ~ "AR",
STATEFIP == 6 ~ "CA",
STATEFIP == 8 ~ "CO",
STATEFIP == 9 ~ "CT",
STATEFIP == 10 ~ "DE",
c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10) !%in% STATEFIP ~ state_name))
gc()
df_samesex <- df_samesex %>%
mutate(state_name = NA) %>% #ok this seems to work
mutate(state_name = case_when(
STATEFIP == 1 ~ "AL",
STATEFIP == 2 ~ "AK",
STATEFIP == 4 ~ "AZ",
STATEFIP == 5 ~ "AR",
STATEFIP == 6 ~ "CA",
STATEFIP == 8 ~ "CO",
STATEFIP == 9 ~ "CT",
STATEFIP == 10 ~ "DE",
STATEFIP %in% !c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)  ~ state_name))
unique(df_samesex%state.name)
unique(df_samesex%state_name)
unique(df_samesex$state_name)
df_samesex <- df_samesex %>%
#  mutate(state_name = NA) %>% #ok this seems to work
mutate(state_name = case_when(
STATEFIP == 1 ~ "AL",
STATEFIP == 2 ~ "AK",
STATEFIP == 4 ~ "AZ",
STATEFIP == 5 ~ "AR",
STATEFIP == 6 ~ "CA",
STATEFIP == 8 ~ "CO",
STATEFIP == 9 ~ "CT",
STATEFIP == 10 ~ "DE",
STATEFIP %in% !c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)  ~ state_name))
unique(df_samesex%state.name)
unique(df_samesex$state_name)
rm(list = ls())
gc()
gc()
library(tidyverse) #for data work
library(data.table) #for data loading
#watch these packages for dummies
install.packages("fastDummies") # --- recipes package might also work or tidymodels? (step_dummy maybe work darn recipe use confusion) (or not- different method) - issue: combo 2 years - check
library(fastDummies)
gc()
pull1_csv <- fread("C:\\Users\\njrich\\Downloads\\pull1.csv")
#note might need to redownload to factor in ASECWT weights - watch individual v household serial and rules of weights - questions about ASECWT only in IPUMS CPS maybe also widow var... hmm.....
gc()
pull1_csv <- pull1_csv %>%
select(-SAMPLE, -CBSERIAL, -HHWT, -CLUSTER, -STRATA, -GQ)
#note: need to add ASECWT weight var after looking
gc()
partner <- pull1_csv %>%
select(YEAR, SERIAL, PERNUM, SEX)
gc()
df_partners <- pull1_csv %>%
left_join(partner, join_by(YEAR, SERIAL, SPLOC == PERNUM), suffix = c(".indv", ".partner"))
gc()
df_samesex <- df_partners %>% #WATCH CLARITY WHERE SPLOC IS
mutate(in_samesex = case_when(
(SEX.indv == 1) & (SEX.partner == 1) ~ 1, #gay
(SEX.indv == 2) & (SEX.partner == 2) ~ 1, #gay
(SEX.indv == 2) & (SEX.partner == 1) ~ 0, #straight
(SEX.indv == 1) & (SEX.partner == 2) ~ 0, #straight
(SEX.indv == 9) | (SEX.partner == 9) ~ NA #NA
))
rm(partner, df_partners, pull1_csv)
#PUT IN PERWT HERE WATCH NEED DIVIDE BY 100 AND GET DECIMALS
#label states
gc()
df_samesex <- df_samesex %>%
mutate(state_name = as.character(STATEFIP)) #better way to do this- see 309 notes too? (fixing state_name=NA issue)
df_samesex <- df_samesex %>% #ok this seems to work
mutate(state_name = case_when(
state_name == "1" ~ "AL",
state_name == "2" ~ "AK",
state_name == "4" ~ "AZ",
state_name == "5" ~ "AR",
state_name == "6" ~ "CA",
state_name == "8" ~ "CO",
state_name == "9" ~ "CT",
state_name == "10" ~ "DE",
TRUE ~ state_name))
gc()
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
state_name == "11" ~ "DC",
state_name == "12" ~ "FL",
state_name == "13" ~ "GA",
state_name == "15" ~ "HI",
state_name == "16" ~ "ID",
state_name == "17" ~ "IL",
state_name == "18" ~ "IN",
state_name == "19" ~ "IA",
state_name == "20" ~ "KS",
TRUE ~ state_name))
gc()
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
state_name == "21" ~ "KY",
state_name == "22" ~ "LA",
state_name == "23" ~ "MI",
state_name == "24" ~ "MD",
state_name == "25" ~ "MA",
state_name == "26" ~ "ME",
state_name == "27" ~ "MN",
state_name == "28" ~ "MS",
state_name == "29" ~ "MO",
state_name == "30" ~ "MT",
TRUE ~ state_name))
gc()
df_samesex <- df_samesex %>%
mutate(state_name = case_when(
state_name == "31" ~ "NE",
state_name == "32" ~ "NV",
state_name == "33" ~ "NH",
state_name == "34" ~ "NJ",
state_name == "35" ~ "NM",
state_name == "36" ~ "NY",
state_name == "37" ~ "NC",
state_name == "38" ~ "ND",
state_name == "39" ~ "OH",
state_name == "40" ~ "OK",
TRUE ~ state_name))
gc()
df_samesex <- df_samesex %>% #this seems to be the only clause that works...
mutate(state_name = case_when(
state_name == "41" ~ "OR",
state_name == "42" ~ "PA",
state_name == "44" ~ "RI",
state_name == "45" ~ "SC",
state_name == "46" ~ "SD",
state_name == "47" ~ "TN",
state_name == "48" ~ "TX",
state_name == "49" ~ "UT",
state_name == "50" ~ "VT",
state_name == "51" ~ "VA",
state_name == "53" ~ "WA",
state_name == "54" ~ "WV",
state_name == "55" ~ "WI",
state_name == "56" ~ "WY",
state_name == "72" ~ "PR",
state_name == "97" ~ "OMI", #Overseas Military Installations
state_name == "99" ~ NA,
TRUE ~ state_name
))
#label legalization date from Gerstmann "2012" OG pqper (see issues)
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = state_name)
df_samesex <- df_samesex %>%
mutate(date_legalization = case_when (
date_legalization == "AL" ~ "2015",
date_legalization == "AK" ~ "2014",
date_legalization == "AZ" ~ "2014",
date_legalization == "AR" ~ "2015",
date_legalization == "CA" ~ "2013", #watch legalized/repealed issue
date_legalization == "CO" ~ "2014",
date_legalization == "CT" ~ "2008",
date_legalization == "DE" ~ "2013",
date_legalization == "DC" ~ "2009",
date_legalization == "FL" ~ "2015",
TRUE ~ date_legalization))
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = case_when(
date_legalization == "GA" ~ "2015",
date_legalization == "HI" ~ "2013",
date_legalization == "ID" ~ "2014",
date_legalization == "IL" ~ "2013",
date_legalization == "IN" ~ "2014",
date_legalization == "IA" ~ "2009",
date_legalization == "KS" ~ "2014",
date_legalization == "KY" ~ "2015",
date_legalization == "LA" ~ "2015",
date_legalization == "ME" ~ "2012",
TRUE ~ date_legalization))
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = case_when(
date_legalization == "MD" ~ "2012",
date_legalization == "MA" ~ "2003",
date_legalization == "MI" ~ "2015",
date_legalization == "MN" ~ "2013",
date_legalization == "MS" ~ "2015",
date_legalization == "MO" ~ "2015",
date_legalization == "MT" ~ "2014",
date_legalization == "NE" ~ "2015",
date_legalization == "NV" ~ "2014",
date_legalization == "NH" ~ "2009",
TRUE ~ date_legalization))
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = case_when(
date_legalization == "NJ" ~ "2013",
date_legalization == "NM" ~ "2013",
date_legalization == "NY" ~ "2011",
date_legalization == "NC" ~ "2014",
date_legalization == "ND" ~ "2015",
date_legalization == "OH" ~ "2015",
date_legalization == "OK" ~ "2014",
date_legalization == "OR" ~ "2014",
date_legalization == "PA" ~ "2014",
date_legalization == "RI" ~ "2013",
TRUE ~ date_legalization))
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = case_when(
date_legalization == "SC" ~ "2014",
date_legalization == "SD" ~ "2015",
date_legalization == "TN" ~ "2015",
date_legalization == "TX" ~ "2015",
date_legalization == "UT" ~ "2014",
date_legalization == "VT" ~ "2009",
date_legalization == "VA" ~ "2014",
date_legalization == "WA" ~ "2012",
date_legalization == "WV" ~ "2014",
date_legalization == "WI" ~ "2014",
date_legalization == "WY" ~ "2014",
date_legalization == "PR" ~ "2015", #from googling
date_legalization == "OMI" ~ "2015", #from guessing
TRUE ~ date_legalization
))
gc()
df_samesex <- df_samesex %>%
mutate(date_legalization = as.numeric(date_legalization))
#make time_since variable
gc()
df_samesex <- df_samesex %>%
mutate(time_since_legalization = if_else(YEAR - date_legalization < 0, NA, YEAR - date_legalization)) #check if this makes sense
#save output of this somewhere for ease of use?
gc()
samesex_staterate <- df_samesex %>%
filter(!is.na(MIGPLAC1)) %>% #get interstate migrants only
group_by(YEAR, state_name) %>%
summarize(samesex_state_count = sum(in_samesex, na.rm = T)) %>%
ungroup() %>%
group_by(YEAR) %>%
mutate(year_totals = sum(samesex_state_count)) %>%
ungroup() %>%
mutate(staterate_year = samesex_state_count/year_totals) %>%
select(YEAR, state_name, staterate_year)
#AND WE'RE FINALLY GOOD YAY GET BACK TO ACTUAL WORK NOW - check if this is excluding anything a la OMI + hmm expect some NAs?
class(df_samesex$PERWT)
head(df_samesex$PERWT)
view(df_samesex$PERWT)
df_samesex <- df_samesex %>% mutate(in_samesex_weighted = in_samesex * PERWT)
gc()
samesex_staterate <- df_samesex %>%
filter(!is.na(MIGPLAC1)) %>% #get interstate migrants only
group_by(YEAR, state_name) %>%
summarize(samesex_state_count = sum(in_samesex_weighted, na.rm = T)) %>%
ungroup() %>%
group_by(YEAR) %>%
mutate(year_totals = sum(samesex_state_count)) %>%
ungroup() %>%
mutate(staterate_year = samesex_state_count/year_totals) %>%
select(YEAR, state_name, staterate_year)
#AND WE'RE FINALLY GOOD YAY GET BACK TO ACTUAL WORK NOW - check if this is excluding anything a la OMI + hmm expect some NAs?
View(samesex_staterate)
view(head(df_samesex))
extra_variables <- df_samesex %>%
select(YEAR, state_name, time_since_legalization)
View(extra_variables)
extra_variables <- df_samesex %>%
select(YEAR, state_name, time_since_legalization) %>%
distinct(YEAR, state_name)
extra_variables <- df_samesex %>%
select(YEAR, state_name, time_since_legalization) %>%
distinct(YEAR, state_name, time_since_legalization)
View(extra_variables)
extra_variables <- df_samesex %>%
distinct(YEAR, state_name, time_since_legalization)
samesex_staterate <- samesex_staterate %>%
left_join(extra_variables, join_by = c(YEAR, state_name))
?left_join
samesex_staterate <- samesex_staterate %>%
left_join(extra_variables, join_by(YEAR, state_name))
View(samesex_staterate)
samesex_staterate <- df_samesex %>%
filter(!is.na(MIGPLAC1)) %>% #get interstate migrants only
group_by(YEAR, state_name) %>%
summarize(samesex_state_count = sum(in_samesex_weighted, na.rm = T)) %>% #note: weight implementation means SE unreliable
ungroup() %>%
group_by(YEAR) %>%
mutate(year_totals = sum(samesex_state_count)) %>%
ungroup() %>%
mutate(staterate_year = samesex_state_count/year_totals) %>%
select(YEAR, state_name, staterate_year)
samesex_staterate <- df_samesex %>%
filter(!is.na(MIGPLAC1)) %>% #get interstate migrants only
group_by(YEAR, state_name) %>%
summarize(samesex_state_count = sum(in_samesex_weighted, na.rm = T)) %>% #note: weight implementation means SE unreliable
ungroup() %>%
group_by(YEAR) %>%
mutate(year_totals = sum(samesex_state_count)) %>%
ungroup() %>%
mutate(staterate_year = samesex_state_count/year_totals) %>%
select(YEAR, state_name, staterate_year)
